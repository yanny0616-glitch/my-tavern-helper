{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/后台生成通知/index.ts","src://tavern_helper_template/util/script.ts"],"sourcesContent":["import { reloadOnChatChange } from '@util/script';\n\nconst BUTTON_SETTINGS = '后台生成通知设置';\nconst AUDIO_DATA_URI =\n  'data:audio/wav;base64,UklGRqQMAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YYAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==';\n\nlet keepAliveAudio: HTMLAudioElement | null = null;\nlet keepAliveEnabled = false;\nlet $settingsModal: JQuery | null = null;\nlet generationStartedAt: number | null = null;\nlet keepAliveStatusText = '未开启';\nlet keepAliveErrorText = '';\n\nfunction updateButtons() {\n  replaceScriptButtons([{ name: BUTTON_SETTINGS, visible: true }]);\n}\n\nfunction ensureAudio() {\n  if (keepAliveAudio) {\n    return;\n  }\n  const parentWindow = window.parent ?? window;\n  const parentDocument = parentWindow.document;\n  const audio = parentDocument.createElement('audio');\n  audio.src = AUDIO_DATA_URI;\n  audio.loop = true;\n  audio.preload = 'auto';\n  audio.setAttribute('playsinline', 'true');\n  audio.setAttribute('webkit-playsinline', 'true');\n  audio.volume = 0.01;\n  audio.muted = false;\n  audio.style.display = 'none';\n  audio.onplay = () => setKeepAliveStatus('播放中');\n  audio.onpause = () => setKeepAliveStatus('已暂停');\n  audio.onended = () => setKeepAliveStatus('已结束');\n  parentDocument.body.appendChild(audio);\n  keepAliveAudio = audio;\n}\n\nfunction getNotificationApi(): typeof Notification | null {\n  try {\n    if (window.parent && 'Notification' in window.parent) {\n      return window.parent.Notification;\n    }\n  } catch (error) {\n    console.warn('无法访问父页面 Notification', error);\n  }\n  if ('Notification' in window) {\n    return Notification;\n  }\n  return null;\n}\n\nfunction getNotificationDebugInfo() {\n  let parentOrigin = 'unknown';\n  let frameOrigin = 'unknown';\n  let parentPermission = 'unknown';\n  let framePermission = 'unknown';\n  const api = getNotificationApi();\n\n  try {\n    parentOrigin = window.parent?.location?.origin ?? 'unknown';\n  } catch {\n    parentOrigin = 'cross-origin';\n  }\n\n  try {\n    frameOrigin = window.location?.origin ?? 'unknown';\n  } catch {\n    frameOrigin = 'unknown';\n  }\n\n  try {\n    parentPermission = window.parent?.Notification?.permission ?? 'unknown';\n  } catch {\n    parentPermission = 'cross-origin';\n  }\n\n  try {\n    framePermission = Notification.permission ?? 'unknown';\n  } catch {\n    framePermission = 'unknown';\n  }\n\n  return {\n    apiAvailable: Boolean(api),\n    parentOrigin,\n    frameOrigin,\n    parentPermission,\n    framePermission,\n  };\n}\n\nasync function requestNotificationPermission() {\n  const api = getNotificationApi();\n  if (!api) {\n    console.warn('当前浏览器不支持系统通知。');\n    return false;\n  }\n  if (api.permission === 'granted') {\n    return true;\n  }\n  const permission = await api.requestPermission();\n  if (permission !== 'granted') {\n    console.warn('未授予系统通知权限，可在浏览器设置中开启。');\n    return false;\n  }\n  console.info('系统通知权限已开启。');\n  return true;\n}\n\nfunction isNotificationGranted() {\n  const api = getNotificationApi();\n  return Boolean(api && api.permission === 'granted');\n}\n\nfunction notifyGenerationDone(messageId?: number) {\n  const api = getNotificationApi();\n  if (api && api.permission === 'granted') {\n    void sendNotification(api, messageId);\n  }\n}\n\nfunction getCurrentCharacterInfo(): { name: string; icon?: string } {\n  try {\n    const chid = Number(SillyTavern.characterId);\n    const character = Number.isFinite(chid) ? SillyTavern.characters?.[chid] : undefined;\n    const name = character?.name || '当前角色';\n    if (character?.avatar && typeof SillyTavern.getThumbnailUrl === 'function') {\n      try {\n        const icon = SillyTavern.getThumbnailUrl('avatar', character.avatar);\n        return { name, icon };\n      } catch (error) {\n        console.warn('获取角色头像失败', error);\n      }\n    }\n    return { name };\n  } catch (error) {\n    console.warn('获取角色信息失败', error);\n    return { name: '当前角色' };\n  }\n}\n\nasync function sendNotification(api: typeof Notification, messageId?: number) {\n  const { name, icon } = getCurrentCharacterInfo();\n  const message = typeof messageId === 'number' ? getChatMessages(messageId)[0] : getChatMessages(-1)[0];\n  const time = getMessageTimeString(message);\n  const durationMs = typeof generationStartedAt === 'number' ? Date.now() - generationStartedAt : null;\n  const duration = durationMs !== null ? formatDuration(durationMs) : null;\n  const tokenCount = await getTokenCountSafe(message?.message);\n\n  const lines = [`角色：${name}`, `时间：${time}`];\n  if (duration) {\n    lines.push(`耗时：${duration}`);\n  }\n  if (typeof tokenCount === 'number') {\n    lines.push(`输出 tokens：${tokenCount}`);\n  }\n\n  const options: NotificationOptions = { body: lines.join('\\n') };\n  if (icon) {\n    options.icon = icon;\n  }\n  new api('生成已完成', options);\n}\n\nfunction getMessageTimeString(message?: { data?: Record<string, any>; extra?: Record<string, any> }) {\n  const candidates = [\n    message?.data?.time,\n    message?.data?.timestamp,\n    message?.data?.send_date,\n    message?.extra?.time,\n    message?.extra?.timestamp,\n    message?.extra?.send_date,\n  ];\n  for (const candidate of candidates) {\n    if (typeof candidate === 'number' && Number.isFinite(candidate)) {\n      return new Date(candidate).toLocaleString();\n    }\n    if (typeof candidate === 'string' && candidate.trim().length > 0) {\n      return candidate;\n    }\n  }\n  return new Date().toLocaleString();\n}\n\nfunction formatDuration(durationMs: number) {\n  if (durationMs < 1000) {\n    return `${durationMs} ms`;\n  }\n  return `${(durationMs / 1000).toFixed(1)} 秒`;\n}\n\nasync function getTokenCountSafe(message?: string) {\n  if (!message || typeof SillyTavern?.getTokenCountAsync !== 'function') {\n    return null;\n  }\n  try {\n    return await SillyTavern.getTokenCountAsync(message);\n  } catch (error) {\n    console.warn('计算输出 token 失败', error);\n    return null;\n  }\n}\n\nasync function startKeepAlive() {\n  ensureAudio();\n  try {\n    await tryPlayAudio();\n    keepAliveEnabled = true;\n    setKeepAliveStatus('播放中');\n    updateButtons();\n    toastr.success('后台保活音频已开启。');\n    await requestNotificationPermission();\n  } catch (error) {\n    keepAliveEnabled = false;\n    setKeepAliveStatus('播放失败');\n    updateButtons();\n    console.warn('静音音频播放失败', error);\n    toastr.error('无法播放静音音频，请在脚本按钮点击后再试。');\n  }\n}\n\nfunction stopKeepAlive() {\n  if (keepAliveAudio) {\n    keepAliveAudio.pause();\n    keepAliveAudio.currentTime = 0;\n    keepAliveAudio.remove();\n    keepAliveAudio = null;\n  }\n  keepAliveEnabled = false;\n  setKeepAliveStatus('已关闭');\n  toastr.info('后台保活音频已关闭。');\n}\n\nfunction setKeepAliveStatus(text: string) {\n  keepAliveStatusText = text;\n  $settingsModal?.find('[data-role=\"keepalive-status\"]').text(`音频状态：${keepAliveStatusText}`);\n}\n\nfunction setKeepAliveError(text: string) {\n  keepAliveErrorText = text;\n  $settingsModal?.find('[data-role=\"keepalive-error\"]').text(keepAliveErrorText);\n}\n\nfunction explainPlayError(error: unknown) {\n  if (error instanceof DOMException) {\n    if (error.name === 'NotAllowedError') {\n      return '播放被浏览器拦截：需要用户交互触发';\n    }\n    if (error.name === 'NotSupportedError') {\n      return '浏览器不支持该音频格式';\n    }\n  }\n  return '播放失败：未知原因';\n}\n\nasync function tryPlayAudio(tempVolume?: number) {\n  ensureAudio();\n  const audio = keepAliveAudio!;\n  const previousVolume = audio.volume;\n  if (typeof tempVolume === 'number') {\n    audio.volume = tempVolume;\n  }\n  try {\n    await audio.play();\n    setKeepAliveError('');\n  } catch (error) {\n    setKeepAliveError(explainPlayError(error));\n    throw error;\n  } finally {\n    if (typeof tempVolume === 'number') {\n      audio.volume = previousVolume;\n    }\n  }\n}\n\nfunction getNotificationStatusText() {\n  const api = getNotificationApi();\n  if (!api) {\n    return '当前浏览器不支持系统通知';\n  }\n  if (api.permission === 'granted') {\n    return '已授权';\n  }\n  if (api.permission === 'denied') {\n    return '已拒绝';\n  }\n  return '未授权';\n}\n\nfunction renderSettingsModal() {\n  const keepAliveChecked = keepAliveEnabled ? 'checked' : '';\n  const notifyStatus = getNotificationStatusText();\n  const debug = getNotificationDebugInfo();\n  return `\n    <div data-role=\"overlay\" style=\"position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.45); z-index: 2147483647; display: flex; align-items: center; justify-content: center; padding: 16px; overflow: auto;\">\n      <div style=\"width: min(360px, 92vw); max-height: calc(100vh - 32px); overflow: auto; background: #fff; color: #111; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.25); padding: 16px;\">\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;\">\n          <div style=\"font-weight: 600; font-size: 16px;\">后台生成通知设置</div>\n          <button data-action=\"close\" style=\"border: 0; background: transparent; font-size: 18px; line-height: 1; cursor: pointer;\">×</button>\n        </div>\n        <div style=\"display: grid; gap: 12px;\">\n          <label style=\"display: flex; align-items: center; gap: 8px; font-size: 14px;\">\n            <input type=\"checkbox\" data-role=\"keepalive\" ${keepAliveChecked} />\n            <span>开启后台保活音频</span>\n          </label>\n          <div style=\"display: flex; align-items: center; gap: 8px; font-size: 14px;\">\n            <button data-action=\"keepalive-start\" style=\"padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;\">开始播放</button>\n            <button data-action=\"keepalive-stop\" style=\"padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;\">停止播放</button>\n            <button data-action=\"keepalive-test\" style=\"padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;\">测试播放</button>\n          </div>\n          <div style=\"font-size: 12px; color: #666; line-height: 1.4;\">\n            <span data-role=\"keepalive-status\">音频状态：${keepAliveStatusText}</span>（iOS 可能仍会限制后台播放）\n          </div>\n          <div style=\"font-size: 12px; color: #b33; line-height: 1.4;\" data-role=\"keepalive-error\">${keepAliveErrorText}</div>\n          <div style=\"display: flex; align-items: center; gap: 8px; font-size: 14px;\">\n            <button data-action=\"notify\" style=\"padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;\">申请系统通知权限</button>\n            <span data-role=\"notify-status\">状态：${notifyStatus}</span>\n          </div>\n          <div style=\"display: flex; align-items: center; gap: 8px; font-size: 14px;\">\n            <button data-action=\"test-notify\" style=\"padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;\">测试系统通知</button>\n            <span data-role=\"test-status\">仅发送系统通知</span>\n          </div>\n          <div style=\"font-size: 12px; color: #666; line-height: 1.4;\">\n            当前来源：${debug.parentOrigin} | 通知权限：${debug.parentPermission} | iframe 权限：${debug.framePermission}\n          </div>\n          <div style=\"font-size: 12px; color: #666; line-height: 1.4;\">\n            iOS 后台会限制脚本运行，保活音频只能尽量减少暂停，不保证锁屏后持续运行。\n          </div>\n        </div>\n      </div>\n    </div>\n  `;\n}\n\nfunction closeSettingsModal() {\n  $settingsModal?.remove();\n  $settingsModal = null;\n}\n\nfunction openSettingsModal() {\n  closeSettingsModal();\n  const parentWindow = window.parent ?? window;\n  const parentDocument = parentWindow.document;\n  const overlay = parentDocument.createElement('div');\n  overlay.setAttribute('script_id', getScriptId());\n  overlay.innerHTML = renderSettingsModal();\n\n  $settingsModal = $(overlay);\n  $settingsModal.appendTo(parentDocument.body);\n\n  $settingsModal.find('[data-action=\"close\"]').on('click', () => {\n    closeSettingsModal();\n  });\n  $settingsModal.find('[data-role=\"overlay\"]').on('click', event => {\n    if (event.target === event.currentTarget) {\n      closeSettingsModal();\n    }\n  });\n\n  $settingsModal.find('[data-role=\"keepalive\"]').on('change', event => {\n    const checked = (event.currentTarget as HTMLInputElement).checked;\n    if (checked) {\n      void startKeepAlive().then(() => {\n        $settingsModal?.find('[data-role=\"keepalive\"]').prop('checked', keepAliveEnabled);\n      });\n    } else {\n      stopKeepAlive();\n    }\n  });\n  $settingsModal.find('[data-action=\"keepalive-start\"]').on('click', () => {\n    void startKeepAlive().then(() => {\n      $settingsModal?.find('[data-role=\"keepalive\"]').prop('checked', keepAliveEnabled);\n    });\n  });\n  $settingsModal.find('[data-action=\"keepalive-stop\"]').on('click', () => {\n    stopKeepAlive();\n    $settingsModal?.find('[data-role=\"keepalive\"]').prop('checked', false);\n  });\n  $settingsModal.find('[data-action=\"keepalive-test\"]').on('click', () => {\n    void (async () => {\n      try {\n        await tryPlayAudio(0.2);\n        setKeepAliveStatus('测试播放中');\n        setTimeout(() => {\n          if (keepAliveAudio) {\n            keepAliveAudio.pause();\n            keepAliveAudio.currentTime = 0;\n          }\n          setKeepAliveStatus('测试完成');\n        }, 400);\n      } catch {\n        setKeepAliveStatus('测试失败');\n      }\n    })();\n  });\n\n  $settingsModal.find('[data-action=\"notify\"]').on('click', () => {\n    void requestNotificationPermission().then(() => {\n      $settingsModal?.find('[data-role=\"notify-status\"]').text(`状态：${getNotificationStatusText()}`);\n    });\n  });\n\n  $settingsModal.find('[data-action=\"test-notify\"]').on('click', () => {\n    void requestNotificationPermission().then(granted => {\n      if (!granted) {\n        $settingsModal?.find('[data-role=\"test-status\"]').text('发送失败：未授权');\n        return;\n      }\n      try {\n        notifyGenerationDone(getLastMessageId());\n        $settingsModal?.find('[data-role=\"test-status\"]').text('已发送系统通知');\n      } catch (error) {\n        console.warn('系统通知发送失败', error);\n        $settingsModal?.find('[data-role=\"test-status\"]').text('发送失败：浏览器拦截');\n      }\n    });\n  });\n}\n\nfunction init() {\n  console.info('[后台生成通知] 脚本已加载');\n  updateButtons();\n  eventOn(getButtonEvent(BUTTON_SETTINGS), () => {\n    openSettingsModal();\n  });\n\n  eventOn(tavern_events.GENERATION_STARTED, () => {\n    generationStartedAt = Date.now();\n  });\n  eventOn(tavern_events.GENERATION_STOPPED, () => {\n    generationStartedAt = null;\n  });\n  eventOn(tavern_events.GENERATION_ENDED, message_id => {\n    notifyGenerationDone(message_id);\n    generationStartedAt = null;\n  });\n  eventOn(iframe_events.GENERATION_STARTED, () => {\n    generationStartedAt = Date.now();\n  });\n  eventOn(iframe_events.GENERATION_ENDED, (_text, message_id) => {\n    notifyGenerationDone(message_id);\n    generationStartedAt = null;\n  });\n\n  const stopReload = reloadOnChatChange();\n\n  $(window).on('pagehide', () => {\n    stopReload.stop();\n    closeSettingsModal();\n    stopKeepAlive();\n  });\n}\n\n$(() => {\n  errorCatched(init)();\n});\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n"],"names":["BUTTON_SETTINGS","keepAliveAudio","keepAliveEnabled","$settingsModal","generationStartedAt","keepAliveStatusText","keepAliveErrorText","updateButtons","replaceScriptButtons","name","visible","ensureAudio","parentDocument","window","parent","document","audio","createElement","src","loop","preload","setAttribute","volume","muted","style","display","onplay","setKeepAliveStatus","onpause","onended","body","appendChild","getNotificationApi","Notification","error","console","warn","async","requestNotificationPermission","api","permission","requestPermission","info","notifyGenerationDone","messageId","icon","chid","Number","SillyTavern","characterId","character","isFinite","characters","undefined","avatar","getThumbnailUrl","getCurrentCharacterInfo","message","getChatMessages","time","candidates","data","timestamp","send_date","extra","candidate","Date","toLocaleString","trim","length","getMessageTimeString","durationMs","now","duration","toFixed","formatDuration","tokenCount","getTokenCountAsync","getTokenCountSafe","lines","push","options","join","sendNotification","startKeepAlive","tryPlayAudio","toastr","success","stopKeepAlive","pause","currentTime","remove","text","find","setKeepAliveError","tempVolume","previousVolume","play","DOMException","explainPlayError","getNotificationStatusText","renderSettingsModal","keepAliveChecked","notifyStatus","debug","parentOrigin","frameOrigin","parentPermission","framePermission","location","origin","apiAvailable","Boolean","getNotificationDebugInfo","closeSettingsModal","init","eventOn","getButtonEvent","overlay","getScriptId","innerHTML","$","appendTo","on","event","target","currentTarget","checked","then","prop","setTimeout","granted","getLastMessageId","openSettingsModal","tavern_events","GENERATION_STARTED","GENERATION_STOPPED","GENERATION_ENDED","message_id","iframe_events","_text","stopReload","chat_id","getCurrentChatId","CHAT_CHANGED","new_chat_id","reload","reloadOnChatChange","stop","errorCatched"],"sourceRoot":""}