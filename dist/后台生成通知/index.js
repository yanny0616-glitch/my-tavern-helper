const A='后台生成通知设置';let n=null,t=!1,e=null,i=null,o='未开启',a='';function r(){replaceScriptButtons([{name:A,visible:!0}])}function s(){if(n)return;const A=(window.parent??window).document,t=A.createElement('audio');t.src='data:audio/wav;base64,UklGRqQMAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YYAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==',t.loop=!0,t.preload='auto',t.setAttribute('playsinline','true'),t.setAttribute('webkit-playsinline','true'),t.volume=.01,t.muted=!1,t.style.display='none',t.onplay=()=>f('播放中'),t.onpause=()=>f('已暂停'),t.onended=()=>f('已结束'),A.body.appendChild(t),n=t}function c(){try{if(window.parent&&'Notification'in window.parent)return window.parent.Notification}catch(A){console.warn('无法访问父页面 Notification',A)}return'Notification'in window?Notification:null}async function l(){const A=c();if(!A)return console.warn('当前浏览器不支持系统通知。'),!1;if('granted'===A.permission)return!0;return'granted'!==await A.requestPermission()?(console.warn('未授予系统通知权限，可在浏览器设置中开启。'),!1):(console.info('系统通知权限已开启。'),!0)}function d(A){const n=c();n&&'granted'===n.permission&&async function(A,n){const{name:t,icon:e}=function(){try{const A=Number(SillyTavern.characterId),n=Number.isFinite(A)?SillyTavern.characters?.[A]:void 0,t=n?.name||'当前角色';if(n?.avatar&&'function'==typeof SillyTavern.getThumbnailUrl)try{return{name:t,icon:SillyTavern.getThumbnailUrl('avatar',n.avatar)}}catch(A){console.warn('获取角色头像失败',A)}return{name:t}}catch(A){return console.warn('获取角色信息失败',A),{name:'当前角色'}}}(),o='number'==typeof n?getChatMessages(n)[0]:getChatMessages(-1)[0],a=function(A){const n=[A?.data?.time,A?.data?.timestamp,A?.data?.send_date,A?.extra?.time,A?.extra?.timestamp,A?.extra?.send_date];for(const A of n){if('number'==typeof A&&Number.isFinite(A))return new Date(A).toLocaleString();if('string'==typeof A&&A.trim().length>0)return A}return(new Date).toLocaleString()}(o),r='number'==typeof i?Date.now()-i:null,s=null!==r?function(A){if(A<1e3)return`${A} ms`;return`${(A/1e3).toFixed(1)} 秒`}(r):null,c=await async function(A){if(!A||'function'!=typeof SillyTavern?.getTokenCountAsync)return null;try{return await SillyTavern.getTokenCountAsync(A)}catch(A){return console.warn('计算输出 token 失败',A),null}}(o?.message),l=[`角色：${t}`,`时间：${a}`];s&&l.push(`耗时：${s}`);'number'==typeof c&&l.push(`输出 tokens：${c}`);const d={body:l.join('\n')};e&&(d.icon=e);new A('生成已完成',d)}(n,A)}async function u(){s();try{await y(),t=!0,f('播放中'),r(),toastr.success('后台保活音频已开启。'),await l()}catch(A){t=!1,f('播放失败'),r(),console.warn('静音音频播放失败',A),toastr.error('无法播放静音音频，请在脚本按钮点击后再试。')}}function p(){n&&(n.pause(),n.currentTime=0,n.remove(),n=null),t=!1,f('已关闭'),toastr.info('后台保活音频已关闭。')}function f(A){o=A,e?.find('[data-role="keepalive-status"]').text(`音频状态：${o}`)}function v(A){a=A,e?.find('[data-role="keepalive-error"]').text(a)}async function y(A){s();const t=n,e=t.volume;'number'==typeof A&&(t.volume=A);try{await t.play(),v('')}catch(A){throw v(function(A){if(A instanceof DOMException){if('NotAllowedError'===A.name)return'播放被浏览器拦截：需要用户交互触发';if('NotSupportedError'===A.name)return'浏览器不支持该音频格式'}return'播放失败：未知原因'}(A)),A}finally{'number'==typeof A&&(t.volume=e)}}function g(){const A=c();return A?'granted'===A.permission?'已授权':'denied'===A.permission?'已拒绝':'未授权':'当前浏览器不支持系统通知'}function m(){const A=t?'checked':'',n=g(),e=function(){let A='unknown',n='unknown',t='unknown',e='unknown';const i=c();try{A=window.parent?.location?.origin??'unknown'}catch{A='cross-origin'}try{n=window.location?.origin??'unknown'}catch{n='unknown'}try{t=window.parent?.Notification?.permission??'unknown'}catch{t='cross-origin'}try{e=Notification.permission??'unknown'}catch{e='unknown'}return{apiAvailable:Boolean(i),parentOrigin:A,frameOrigin:n,parentPermission:t,framePermission:e}}();return`\n    <div data-role="overlay" style="position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.45); z-index: 2147483647; display: flex; align-items: center; justify-content: center; padding: 16px; overflow: auto;">\n      <div style="width: min(360px, 92vw); max-height: calc(100vh - 32px); overflow: auto; background: #fff; color: #111; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.25); padding: 16px;">\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">\n          <div style="font-weight: 600; font-size: 16px;">后台生成通知设置</div>\n          <button data-action="close" style="border: 0; background: transparent; font-size: 18px; line-height: 1; cursor: pointer;">×</button>\n        </div>\n        <div style="display: grid; gap: 12px;">\n          <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n            <input type="checkbox" data-role="keepalive" ${A} />\n            <span>开启后台保活音频</span>\n          </label>\n          <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n            <button data-action="keepalive-start" style="padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;">开始播放</button>\n            <button data-action="keepalive-stop" style="padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;">停止播放</button>\n            <button data-action="keepalive-test" style="padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;">测试播放</button>\n          </div>\n          <div style="font-size: 12px; color: #666; line-height: 1.4;">\n            <span data-role="keepalive-status">音频状态：${o}</span>（iOS 可能仍会限制后台播放）\n          </div>\n          <div style="font-size: 12px; color: #b33; line-height: 1.4;" data-role="keepalive-error">${a}</div>\n          <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n            <button data-action="notify" style="padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;">申请系统通知权限</button>\n            <span data-role="notify-status">状态：${n}</span>\n          </div>\n          <div style="display: flex; align-items: center; gap: 8px; font-size: 14px;">\n            <button data-action="test-notify" style="padding: 6px 10px; border: 1px solid #ccc; background: #f7f7f7; border-radius: 6px; cursor: pointer;">测试系统通知</button>\n            <span data-role="test-status">仅发送系统通知</span>\n          </div>\n          <div style="font-size: 12px; color: #666; line-height: 1.4;">\n            当前来源：${e.parentOrigin} | 通知权限：${e.parentPermission} | iframe 权限：${e.framePermission}\n          </div>\n          <div style="font-size: 12px; color: #666; line-height: 1.4;">\n            iOS 后台会限制脚本运行，保活音频只能尽量减少暂停，不保证锁屏后持续运行。\n          </div>\n        </div>\n      </div>\n    </div>\n  `}function w(){e?.remove(),e=null}function x(){console.info('[后台生成通知] 脚本已加载'),r(),eventOn(getButtonEvent(A),()=>{!function(){w();const A=(window.parent??window).document,i=A.createElement('div');i.setAttribute('script_id',getScriptId()),i.innerHTML=m(),e=$(i),e.appendTo(A.body),e.find('[data-action="close"]').on('click',()=>{w()}),e.find('[data-role="overlay"]').on('click',A=>{A.target===A.currentTarget&&w()}),e.find('[data-role="keepalive"]').on('change',A=>{A.currentTarget.checked?u().then(()=>{e?.find('[data-role="keepalive"]').prop('checked',t)}):p()}),e.find('[data-action="keepalive-start"]').on('click',()=>{u().then(()=>{e?.find('[data-role="keepalive"]').prop('checked',t)})}),e.find('[data-action="keepalive-stop"]').on('click',()=>{p(),e?.find('[data-role="keepalive"]').prop('checked',!1)}),e.find('[data-action="keepalive-test"]').on('click',()=>{(async()=>{try{await y(.2),f('测试播放中'),setTimeout(()=>{n&&(n.pause(),n.currentTime=0),f('测试完成')},400)}catch{f('测试失败')}})()}),e.find('[data-action="notify"]').on('click',()=>{l().then(()=>{e?.find('[data-role="notify-status"]').text(`状态：${g()}`)})}),e.find('[data-action="test-notify"]').on('click',()=>{l().then(A=>{if(A)try{d(getLastMessageId()),e?.find('[data-role="test-status"]').text('已发送系统通知')}catch(A){console.warn('系统通知发送失败',A),e?.find('[data-role="test-status"]').text('发送失败：浏览器拦截')}else e?.find('[data-role="test-status"]').text('发送失败：未授权')})})}()}),eventOn(tavern_events.GENERATION_STARTED,()=>{i=Date.now()}),eventOn(tavern_events.GENERATION_STOPPED,()=>{i=null}),eventOn(tavern_events.GENERATION_ENDED,A=>{d(A),i=null}),eventOn(iframe_events.GENERATION_STARTED,()=>{i=Date.now()}),eventOn(iframe_events.GENERATION_ENDED,(A,n)=>{d(n),i=null});const o=function(){let A=SillyTavern.getCurrentChatId();return eventOn(tavern_events.CHAT_CHANGED,n=>{A!==n&&(A=n,window.location.reload())})}();$(window).on('pagehide',()=>{o.stop(),w(),p()})}$(()=>{errorCatched(x)()});
//# sourceMappingURL=index.js.map