const e={type:'script',script_id:getScriptId()},n='管理快捷语句';function a(e,n){return e.macros.filter(e=>!!e.enabled&&('global'===e.scope||e.characterId&&e.characterId===n))}function t(){const e=SillyTavern?.characterId??SillyTavern?.getContext?.().characterId??'';return null==e?'':String(e)}const r=[{id:'append',prepare:e=>{e.state.mode=e.macro.send?'replace':e.macro.append?'append':'replace'}},{id:'newline',prepare:e=>{e.state.newline=e.macro.newline}},{id:'send',afterApply:async e=>{if(!e.macro.send)return;const n=e.replacement??'';n.trim()?(e.setInputValue(n),SillyTavern.activateSendButtons?.(),setTimeout(()=>{(function(){const e=$('#send_but, #send_button, #send').first();return e.length?(e.trigger('click'),!0):(toastr.warning('未找到发送按钮，请手动发送。'),!1)})()&&setTimeout(()=>e.clearInput(),300)},0)):toastr.warning('快捷语句为空，未发送。')}}];async function o(e){const n=function(){const e=['#send_textarea','#sendTextArea','#send-textarea','textarea#send_textarea','textarea#sendTextArea','textarea#send-textarea','textarea[name="send_textarea"]'];for(const n of e){const e=$(n).first();if(e.length)return e}return null}();if(!n)return void toastr.error('未找到输入框，无法插入快捷语句。');const a=String(n.val()??''),t={macro:e,input:n,current:a,content:e.content,state:{mode:'replace',newline:!0},replacement:null,setContent(e){t.content=e},setReplacement(e){t.replacement=e},setInputValue(e){n.val(e),n.trigger('input'),n.trigger('change')},clearInput(){n.val(''),n.trigger('input'),n.trigger('change')}};await async function(e,n=r){n.forEach(n=>n.prepare?.(e)),null===e.replacement&&e.setReplacement(function(e){const n=e.content;if('append'===e.state.mode){const a=e.current&&e.state.newline?'\n':'';return`${e.current}${a}${n}`}return`${n}${e.state.newline?'\n':''}`}(e));const a=e.replacement??'';e.setInputValue(a);for(const a of n)a.afterApply&&await a.afterApply(e)}(t),n.trigger('focus')}function c(e){return e.map(e=>({...e,id:e.id||SillyTavern.uuidv4()}))}function l(e,n){return e.map(e=>'character'!==e.scope||e.characterId?e:{...e,characterId:n})}function i(e){const a=[],t=new Set,r=[];for(const o of e){const e=o.name.trim();e?e!==n?t.has(e)?a.push(`快捷语句名称 "${e}" 重复，已忽略后续条目。`):(t.add(e),r.push({...o,name:e})):a.push(`快捷语句名称 "${n}" 保留，已忽略。`):a.push('忽略空名称的快捷语句。')}return{macros:c(r),warnings:a}}function d(e,n){const a=new Set(n.map(e=>e.name));if(!a.has(e))return e;let t=2;for(;a.has(`${e} ${t}`);)t+=1;return`${e} ${t}`}const s=z,m=s.z.object({bg:s.z.string().default('#f6f1ea'),surface:s.z.string().default('#ffffff'),surfaceAlt:s.z.string().default('#f1ebe4'),text:s.z.string().default('#1c1c1c'),textMuted:s.z.string().default('#6a5f54'),accent:s.z.string().default('#d9934f'),border:s.z.string().default('#e3d6c9')}).prefault({}),p=s.z.object({id:s.z.string().default(''),name:s.z.string().default(''),content:s.z.string().default(''),send:s.z.boolean().default(!1),append:s.z.boolean().default(!1),newline:s.z.boolean().default(!0),scope:s.z.enum(['global','character']).default('global'),characterId:s.z.string().default(''),pinned:s.z.boolean().default(!1),lastUsedAt:s.z.number().default(0),enabled:s.z.boolean().default(!0)}).prefault({}),u=s.z.object({macros:s.z.array(p).default([]),theme:m.default({})}).prefault({macros:[],theme:m.parse({})}),f=[{id:'',name:'问候',content:'你好！',send:!1,append:!1,newline:!0,scope:'global',characterId:'',pinned:!1,lastUsedAt:0,enabled:!0},{id:'',name:'继续',content:'继续。',send:!0,append:!1,newline:!0,scope:'global',characterId:'',pinned:!1,lastUsedAt:0,enabled:!0}],v=m.parse({});function b(n){replaceVariables(n,e)}const x=Vue,g=Symbol('MacroUi'),h={class:'macro-item__row'},y={class:'macro-item__name'},k={class:'macro-item__actions'},V=['aria-label','title'],E=['aria-label','title'],N={class:'macro-item__meta'},w={class:'macro-tag'},C={key:0,class:'macro-tag'},B={key:1,class:'macro-tag'},M={key:2,class:'macro-tag'},T={key:3,class:'macro-tag'},D={key:4,class:'macro-tag'},I={key:5,class:'macro-tag'},S=(0,x.defineComponent)({__name:'MacroListItem',props:{macro:{},mode:{},characterLabel:{}},emits:['pin','duplicate','hide','toggle','edit','delete'],setup(e,{emit:n}){const a=n;return(n,t)=>((0,x.openBlock)(),(0,x.createElementBlock)(x.Fragment,null,[(0,x.createElementVNode)('div',h,[(0,x.createElementVNode)('div',y,(0,x.toDisplayString)(e.macro.name||'未命名'),1),(0,x.createElementVNode)('div',k,[(0,x.createElementVNode)('button',{class:'macro-icon-btn',type:'button','aria-label':e.macro.pinned?'取消收藏':'收藏',title:e.macro.pinned?'取消收藏':'收藏',onClick:t[0]||(t[0]=(0,x.withModifiers)(n=>a('pin',e.macro.id),['stop']))},[(0,x.createElementVNode)('i',{class:(0,x.normalizeClass)(['macro-icon',e.macro.pinned?'fa-solid fa-star is-pinned':'fa-regular fa-star']),'aria-hidden':'true'},null,2)],8,V),'active'===e.mode?((0,x.openBlock)(),(0,x.createElementBlock)(x.Fragment,{key:0},[(0,x.createElementVNode)('button',{class:'macro-icon-btn',type:'button','aria-label':'复制',title:'复制',onClick:t[1]||(t[1]=(0,x.withModifiers)(n=>a('duplicate',e.macro.id),['stop']))},[...t[6]||(t[6]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-regular fa-copy','aria-hidden':'true'},null,-1)])]),(0,x.createElementVNode)('button',{class:'macro-icon-btn',type:'button','aria-label':'移出列表',title:'移出列表',onClick:t[2]||(t[2]=(0,x.withModifiers)(n=>a('hide',e.macro.id),['stop']))},[...t[7]||(t[7]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-regular fa-eye-slash','aria-hidden':'true'},null,-1)])])],64)):((0,x.openBlock)(),(0,x.createElementBlock)(x.Fragment,{key:1},[(0,x.createElementVNode)('button',{class:'macro-icon-btn',type:'button','aria-label':e.macro.enabled?'移出快捷回复':'加入快捷回复',title:e.macro.enabled?'移出快捷回复':'加入快捷回复',onClick:t[3]||(t[3]=(0,x.withModifiers)(n=>a('toggle',e.macro.id),['stop']))},[(0,x.createElementVNode)('i',{class:(0,x.normalizeClass)(['macro-icon',e.macro.enabled?'fa-solid fa-minus':'fa-solid fa-plus']),'aria-hidden':'true'},null,2)],8,E),(0,x.createElementVNode)('button',{class:'macro-icon-btn',type:'button','aria-label':'编辑',title:'编辑',onClick:t[4]||(t[4]=(0,x.withModifiers)(n=>a('edit',e.macro.id),['stop']))},[...t[8]||(t[8]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-regular fa-pen-to-square','aria-hidden':'true'},null,-1)])]),(0,x.createElementVNode)('button',{class:'macro-icon-btn',type:'button','aria-label':'删除',title:'删除',onClick:t[5]||(t[5]=(0,x.withModifiers)(n=>a('delete',e.macro.id),['stop']))},[...t[9]||(t[9]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-regular fa-trash-can','aria-hidden':'true'},null,-1)])])],64))])]),(0,x.createElementVNode)('div',N,[(0,x.createElementVNode)('span',w,[(0,x.createElementVNode)('i',{class:(0,x.normalizeClass)(['macro-icon fa-solid','global'===e.macro.scope?'fa-globe':'fa-user']),'aria-hidden':'true'},null,2),(0,x.createTextVNode)(' '+(0,x.toDisplayString)('global'===e.macro.scope?'全局':'角色'),1)]),'character'===e.macro.scope&&e.characterLabel?((0,x.openBlock)(),(0,x.createElementBlock)('span',C,[t[10]||(t[10]=(0,x.createElementVNode)('i',{class:'macro-icon fa-regular fa-id-badge','aria-hidden':'true'},null,-1)),(0,x.createTextVNode)(' '+(0,x.toDisplayString)(e.characterLabel),1)])):(0,x.createCommentVNode)('v-if',!0),e.macro.send?((0,x.openBlock)(),(0,x.createElementBlock)('span',B,[...t[11]||(t[11]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-regular fa-paper-plane','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 发送 ',-1)])])):(0,x.createCommentVNode)('v-if',!0),e.macro.append?((0,x.openBlock)(),(0,x.createElementBlock)('span',M,[...t[12]||(t[12]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-plus','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 追加 ',-1)])])):(0,x.createCommentVNode)('v-if',!0),e.macro.send||e.macro.append?(0,x.createCommentVNode)('v-if',!0):((0,x.openBlock)(),(0,x.createElementBlock)('span',T,[...t[13]||(t[13]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-regular fa-square','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 覆盖 ',-1)])])),e.macro.newline?(0,x.createCommentVNode)('v-if',!0):((0,x.openBlock)(),(0,x.createElementBlock)('span',D,[...t[14]||(t[14]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-ban','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 无换行 ',-1)])])),e.macro.enabled?(0,x.createCommentVNode)('v-if',!0):((0,x.openBlock)(),(0,x.createElementBlock)('span',I,[...t[15]||(t[15]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-regular fa-eye-slash','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 未显示 ',-1)])]))])],64))}}),A=[{name:'白天',colors:{bg:'#f6f1ea',surface:'#ffffff',surfaceAlt:'#f1ebe4',text:'#1c1c1c',textMuted:'#6a5f54',accent:'#d9934f',border:'#e3d6c9'}},{name:'夜晚',colors:{bg:'#0f1115',surface:'#1b1f27',surfaceAlt:'#232836',text:'#f5f5f7',textMuted:'#a7b0c0',accent:'#4cc3ff',border:'#2f3647'}},{name:'雾蓝',colors:{bg:'#e8eef6',surface:'#f7f9fc',surfaceAlt:'#e3ecf7',text:'#1b2533',textMuted:'#5b6b7f',accent:'#5e8cff',border:'#c8d6ea'}},{name:'琥珀',colors:{bg:'#f7efe4',surface:'#fff7ee',surfaceAlt:'#f4e3d0',text:'#2a1f17',textMuted:'#6f5a4a',accent:'#c9783b',border:'#e3c9b2'}}],U={class:'macro-panel',role:'dialog','aria-label':'快捷语句管理'},K={class:'macro-header'},j={class:'macro-header-actions'},L={class:'macro-body'},F={class:'macro-sidebar'},P={class:'macro-list'},H={key:0,class:'macro-empty-list'},q={key:0,class:'macro-subtitle'},R={key:1,class:'macro-group'},W=['onClick','onKeydown'],Y={key:2,class:'macro-subtitle'},O={key:3,class:'macro-group'},G=['onClick','onKeydown'],X={class:'macro-actions'},J={class:'macro-content'},Q={class:'macro-field'},Z={key:1,class:'macro-empty'},ee={key:0,class:'macro-field'},ne={key:1,class:'macro-field'},ae={class:'macro-scope-row'},te={key:1,class:'macro-scope-hint'},re={key:2,class:'macro-toggle-row'},oe={class:'macro-toggle'},ce=['disabled'],le=['disabled'],ie={class:'macro-footer'},de={class:'macro-library-panel',role:'dialog','aria-label':'宏库管理'},se={class:'macro-library-header'},me={class:'macro-library-body'},pe={class:'macro-search'},ue={class:'macro-filters'},fe={class:'macro-library-list'},ve={class:'macro-list'},be={class:'macro-group'},xe=['onClick','onKeydown'],ge={key:0,class:'macro-empty-list'},he={class:'macro-group'},ye=['onClick','onKeydown'],ke={key:1,class:'macro-subtitle'},Ve={key:2,class:'macro-group'},Ee=['onClick','onKeydown'],Ne={key:3,class:'macro-subtitle'},we={key:4,class:'macro-group'},Ce=['onClick','onKeydown'],Be={key:5,class:'macro-empty-list'},ze={key:0,class:'macro-library-editor'},Me={class:'macro-editor'},Te={class:'macro-field'},_e={class:'macro-field'},De={class:'macro-field'},Ie={class:'macro-scope-row'},Se={key:1,class:'macro-scope-hint'},Ae={class:'macro-toggle-row'},Ue={class:'macro-toggle'},Ke={class:'macro-toggle'},$e={class:'macro-library-footer'},je={class:'macro-theme-panel',role:'dialog','aria-label':'主题配色设置'},Le={class:'macro-theme-header'},Fe={class:'macro-theme-body'},Pe={class:'macro-theme-presets'},He=['onClick'],qe={class:'macro-theme-grid'},Re={class:'macro-theme-item'},We={class:'macro-theme-item'},Ye={class:'macro-theme-item'},Oe={class:'macro-theme-item'},Ge={class:'macro-theme-item'},Xe={class:'macro-theme-item'},Je={class:'macro-theme-item'},Qe={class:'macro-theme-footer'},Ze=(0,x.defineComponent)({__name:'App',setup(e){const n=(0,x.inject)(g);if(!n)throw new Error('Macro UI context missing.');const{visible:a,macros:r,theme:o,selectedId:c,selectedMacro:l,selectMacro:i,currentCharacterLabel:s,bindCurrentCharacter:m,close:p,addMacro:u,duplicateMacro:f,removeMacro:v,moveMacro:b,resetTheme:h,save:y}=n,k=(0,x.ref)(!1),V=(0,x.ref)(!1),E=(0,x.ref)(null),N=(0,x.ref)(''),w=(0,x.ref)('all'),C=(0,x.ref)(!1),B=(0,x.ref)(!1),M=(0,x.ref)(null),T=(0,x.ref)(null),D=(0,x.computed)(()=>N.value.trim().toLowerCase()),I=e=>{const n=D.value;if(n){if(!`${e.name} ${e.content}`.toLowerCase().includes(n))return!1}return('all'===w.value||e.scope===w.value)&&!(C.value&&!e.pinned)},Ze=(0,x.computed)(()=>r.value.filter(I)),en=(0,x.computed)(()=>r.value.filter(e=>e.enabled)),nn=(0,x.computed)(()=>r.value.filter(e=>e.lastUsedAt>0).sort((e,n)=>n.lastUsedAt-e.lastUsedAt)),an=(0,x.computed)(()=>nn.value.filter(I)),tn=(0,x.computed)(()=>an.value.slice(0,5)),rn=(0,x.computed)(()=>!B.value&&!D.value&&tn.value.length>0),on=e=>[...e.filter(e=>e.pinned),...e.filter(e=>!e.pinned)],cn=(0,x.computed)(()=>({global:on(Ze.value.filter(e=>'global'===e.scope)),character:on(Ze.value.filter(e=>'character'===e.scope))})),ln=(0,x.computed)(()=>({global:on(en.value.filter(e=>'global'===e.scope)),character:on(en.value.filter(e=>'character'===e.scope))})),dn=(0,x.computed)(()=>r.value.find(e=>e.id===E.value)??null),sn=(0,x.computed)({get:()=>l.value?l.value.send?'send':l.value.append?'append':'replace':'replace',set(e){l.value&&(l.value.send='send'===e,l.value.append='append'===e)}}),mn=e=>'character'!==e.scope?'':(e=>{const n=Number(e),a=SillyTavern?.characters;return!Number.isNaN(n)&&a?.[n]?.name?a[n].name:e?`角色ID：${e}`:''})(e.characterId),pn=()=>{const e=M.value;e&&(e.style.height='auto',e.style.height=`${e.scrollHeight}px`)},un=()=>{const e=T.value;e&&(e.style.height='auto',e.style.height=`${e.scrollHeight}px`)};(0,x.watch)(()=>l.value?.content,async()=>{await(0,x.nextTick)(),pn()},{immediate:!0}),(0,x.watch)(()=>dn.value?.content,async()=>{await(0,x.nextTick)(),un()},{immediate:!0}),(0,x.watch)(()=>a.value,e=>{e||(V.value=!1,k.value=!1)}),(0,x.watch)(()=>V.value,e=>{e||!l.value||l.value.enabled||(c.value=en.value[0]?.id??null)}),(0,x.watch)(()=>Ze.value,e=>{V.value&&(E.value&&e.some(e=>e.id===E.value)||(E.value=null))},{deep:!0});const fn=e=>{i(e),f()},vn=e=>{const n=r.value.findIndex(n=>n.id===e);if(n<0)return;const a=c.value===e,t=E.value===e;r.value.splice(n,1),a&&(c.value=en.value[0]?.id??null),t&&(E.value=Ze.value[0]?.id??null)},bn=e=>{const n=r.value.find(n=>n.id===e);n&&(n.pinned=!n.pinned)},xn=e=>{const n=r.value.find(n=>n.id===e);n&&(n.enabled=!n.enabled)},gn=e=>{const n=r.value.find(n=>n.id===e);n&&(n.enabled=!1,c.value===e&&(c.value=en.value[0]?.id??null),E.value===e&&(E.value=null))},hn=e=>{E.value=e},yn=e=>{E.value=e},kn=()=>{((e,n)=>{const a={id:SillyTavern.uuidv4(),name:d('新快捷语句',r.value),content:'',send:!1,append:!1,newline:!0,scope:'global',characterId:'',pinned:!1,lastUsedAt:0,enabled:e};r.value.push(a),n&&(c.value=a.id),E.value=a.id})(!1,!1)},Vn=e=>{e&&(E.value=null),V.value=!0},En=(0,x.computed)({get:()=>dn.value?dn.value.send?'send':dn.value.append?'append':'replace':'replace',set(e){dn.value&&(dn.value.send='send'===e,dn.value.append='append'===e)}}),Nn=()=>{const e=dn.value;e&&(e.scope='character',e.characterId=t())};return(e,n)=>((0,x.openBlock)(),(0,x.createElementBlock)('div',{class:(0,x.normalizeClass)(['macro-root',{open:(0,x.unref)(a)}])},[(0,x.createElementVNode)('div',{class:'macro-backdrop',onClick:n[0]||(n[0]=(...e)=>(0,x.unref)(p)&&(0,x.unref)(p)(...e))}),(0,x.createElementVNode)('section',U,[(0,x.createElementVNode)('header',K,[n[46]||(n[46]=(0,x.createElementVNode)('div',{class:'macro-title'},[(0,x.createElementVNode)('div',{class:'macro-title__main'},'快捷语句管理'),(0,x.createElementVNode)('div',{class:'macro-title__sub'},'更新后会同步脚本按钮，支持发送/追加/换行控制。')],-1)),(0,x.createElementVNode)('div',j,[(0,x.createElementVNode)('button',{class:'macro-icon-btn',type:'button','aria-label':'宏库',title:'宏库',onClick:n[1]||(n[1]=e=>Vn(!0))},[...n[43]||(n[43]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-layer-group','aria-hidden':'true'},null,-1)])]),(0,x.createElementVNode)('button',{class:'macro-icon-btn',type:'button','aria-label':'配色',title:'配色',onClick:n[2]||(n[2]=e=>k.value=!0)},[...n[44]||(n[44]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-palette','aria-hidden':'true'},null,-1)])]),(0,x.createElementVNode)('button',{class:'macro-close',type:'button','aria-label':'关闭',title:'关闭',onClick:n[3]||(n[3]=(...e)=>(0,x.unref)(p)&&(0,x.unref)(p)(...e))},[...n[45]||(n[45]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-xmark','aria-hidden':'true'},null,-1)])])])]),(0,x.createElementVNode)('div',L,[(0,x.createElementVNode)('aside',F,[n[49]||(n[49]=(0,x.createElementVNode)('div',{class:'macro-section-title'},'快捷语句列表',-1)),(0,x.createElementVNode)('div',P,[ln.value.global.length||ln.value.character.length?((0,x.openBlock)(),(0,x.createElementBlock)(x.Fragment,{key:1},[ln.value.global.length?((0,x.openBlock)(),(0,x.createElementBlock)('div',q,'全局')):(0,x.createCommentVNode)('v-if',!0),ln.value.global.length?((0,x.openBlock)(),(0,x.createElementBlock)('div',R,[((0,x.openBlock)(!0),(0,x.createElementBlock)(x.Fragment,null,(0,x.renderList)(ln.value.global,e=>((0,x.openBlock)(),(0,x.createElementBlock)('div',{key:e.id,class:(0,x.normalizeClass)(['macro-item',{active:e.id===(0,x.unref)(c)}]),onClick:n=>(0,x.unref)(i)(e.id),role:'button',tabindex:'0',onKeydown:[(0,x.withKeys)((0,x.withModifiers)(n=>(0,x.unref)(i)(e.id),['prevent']),['enter']),(0,x.withKeys)((0,x.withModifiers)(n=>(0,x.unref)(i)(e.id),['prevent']),['space'])]},[(0,x.createVNode)(S,{macro:e,mode:'active','character-label':mn(e),onPin:bn,onDuplicate:fn,onHide:gn},null,8,['macro','character-label'])],42,W))),128))])):(0,x.createCommentVNode)('v-if',!0),ln.value.character.length?((0,x.openBlock)(),(0,x.createElementBlock)('div',Y,'角色')):(0,x.createCommentVNode)('v-if',!0),ln.value.character.length?((0,x.openBlock)(),(0,x.createElementBlock)('div',O,[((0,x.openBlock)(!0),(0,x.createElementBlock)(x.Fragment,null,(0,x.renderList)(ln.value.character,e=>((0,x.openBlock)(),(0,x.createElementBlock)('div',{key:e.id,class:(0,x.normalizeClass)(['macro-item',{active:e.id===(0,x.unref)(c)}]),onClick:n=>(0,x.unref)(i)(e.id),role:'button',tabindex:'0',onKeydown:[(0,x.withKeys)((0,x.withModifiers)(n=>(0,x.unref)(i)(e.id),['prevent']),['enter']),(0,x.withKeys)((0,x.withModifiers)(n=>(0,x.unref)(i)(e.id),['prevent']),['space'])]},[(0,x.createVNode)(S,{macro:e,mode:'active','character-label':mn(e),onPin:bn,onDuplicate:fn,onHide:gn},null,8,['macro','character-label'])],42,G))),128))])):(0,x.createCommentVNode)('v-if',!0)],64)):((0,x.openBlock)(),(0,x.createElementBlock)('div',H,[n[47]||(n[47]=(0,x.createTextVNode)(' 当前没有显示的快捷语句 ',-1)),(0,x.createElementVNode)('button',{class:'macro-btn is-ghost',type:'button',onClick:n[4]||(n[4]=e=>Vn(!0))},'打开宏库')]))]),(0,x.createElementVNode)('div',X,[(0,x.createElementVNode)('button',{class:'macro-btn',type:'button',onClick:n[5]||(n[5]=(...e)=>(0,x.unref)(u)&&(0,x.unref)(u)(...e))},[...n[48]||(n[48]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-plus','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 新增 ',-1)])])])]),(0,x.createElementVNode)('main',J,[(0,x.createElementVNode)('div',Q,[n[50]||(n[50]=(0,x.createElementVNode)('div',{class:'macro-section-title'},'编辑快捷语句',-1)),n[51]||(n[51]=(0,x.createElementVNode)('label',null,'名称',-1)),(0,x.unref)(l)?(0,x.withDirectives)(((0,x.openBlock)(),(0,x.createElementBlock)('input',{key:0,class:'macro-input','data-focus':'name','onUpdate:modelValue':n[6]||(n[6]=e=>(0,x.unref)(l).name=e),placeholder:'例如：继续'},null,512)),[[x.vModelText,(0,x.unref)(l).name]]):((0,x.openBlock)(),(0,x.createElementBlock)('div',Z,'请选择左侧语句'))]),(0,x.unref)(l)?((0,x.openBlock)(),(0,x.createElementBlock)('div',ee,[n[52]||(n[52]=(0,x.createElementVNode)('label',null,'内容',-1)),(0,x.withDirectives)((0,x.createElementVNode)('textarea',{ref_key:'contentRef',ref:M,class:'macro-textarea','onUpdate:modelValue':n[7]||(n[7]=e=>(0,x.unref)(l).content=e),placeholder:'输入要插入的文本',onInput:pn},null,544),[[x.vModelText,(0,x.unref)(l).content]])])):(0,x.createCommentVNode)('v-if',!0),(0,x.unref)(l)?((0,x.openBlock)(),(0,x.createElementBlock)('div',ne,[n[54]||(n[54]=(0,x.createElementVNode)('label',null,'作用范围',-1)),(0,x.createElementVNode)('div',ae,[(0,x.withDirectives)((0,x.createElementVNode)('select',{'onUpdate:modelValue':n[8]||(n[8]=e=>(0,x.unref)(l).scope=e),class:'macro-select'},[...n[53]||(n[53]=[(0,x.createElementVNode)('option',{value:'global'},'全局快捷回复',-1),(0,x.createElementVNode)('option',{value:'character'},'角色快捷回复',-1)])],512),[[x.vModelSelect,(0,x.unref)(l).scope]]),'character'===(0,x.unref)(l).scope?((0,x.openBlock)(),(0,x.createElementBlock)('button',{key:0,class:'macro-btn is-ghost',type:'button',onClick:n[9]||(n[9]=(...e)=>(0,x.unref)(m)&&(0,x.unref)(m)(...e))},' 绑定当前角色 ')):(0,x.createCommentVNode)('v-if',!0),'character'===(0,x.unref)(l).scope?((0,x.openBlock)(),(0,x.createElementBlock)('span',te,(0,x.toDisplayString)((0,x.unref)(s)),1)):(0,x.createCommentVNode)('v-if',!0)])])):(0,x.createCommentVNode)('v-if',!0),(0,x.unref)(l)?((0,x.openBlock)(),(0,x.createElementBlock)('div',re,[n[59]||(n[59]=(0,x.createElementVNode)('label',{class:'macro-toggle'},'发送方式',-1)),(0,x.withDirectives)((0,x.createElementVNode)('select',{'onUpdate:modelValue':n[10]||(n[10]=e=>sn.value=e),class:'macro-select'},[...n[55]||(n[55]=[(0,x.createElementVNode)('option',{value:'send'},'直接发送',-1),(0,x.createElementVNode)('option',{value:'append'},'追加到输入框',-1),(0,x.createElementVNode)('option',{value:'replace'},'覆盖输入框',-1)])],512),[[x.vModelSelect,sn.value]]),(0,x.createElementVNode)('label',oe,[(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':n[11]||(n[11]=e=>(0,x.unref)(l).newline=e)},null,512),[[x.vModelCheckbox,(0,x.unref)(l).newline]]),n[56]||(n[56]=(0,x.createTextVNode)(' 自动换行',-1))]),(0,x.createElementVNode)('button',{class:'macro-btn is-ghost',type:'button',disabled:!(0,x.unref)(l),onClick:n[12]||(n[12]=e=>(0,x.unref)(b)(-1))},[...n[57]||(n[57]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-arrow-up','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 上移 ',-1)])],8,ce),(0,x.createElementVNode)('button',{class:'macro-btn is-ghost',type:'button',disabled:!(0,x.unref)(l),onClick:n[13]||(n[13]=e=>(0,x.unref)(b)(1))},[...n[58]||(n[58]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-arrow-down','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 下移 ',-1)])],8,le)])):(0,x.createCommentVNode)('v-if',!0)])]),(0,x.createElementVNode)('footer',ie,[(0,x.createElementVNode)('button',{class:'macro-btn is-ghost',type:'button',onClick:n[14]||(n[14]=(...e)=>(0,x.unref)(p)&&(0,x.unref)(p)(...e))},[...n[60]||(n[60]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-xmark','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 取消 ',-1)])]),(0,x.createElementVNode)('button',{class:'macro-btn is-primary',type:'button',onClick:n[15]||(n[15]=(...e)=>(0,x.unref)(y)&&(0,x.unref)(y)(...e))},[...n[61]||(n[61]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-check','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 保存 ',-1)])])])]),V.value?((0,x.openBlock)(),(0,x.createElementBlock)('div',{key:0,class:'macro-library-modal',onClick:n[31]||(n[31]=(0,x.withModifiers)(e=>V.value=!1,['self']))},[(0,x.createElementVNode)('section',de,[(0,x.createElementVNode)('header',se,[n[63]||(n[63]=(0,x.createElementVNode)('div',null,[(0,x.createElementVNode)('div',{class:'macro-theme-title'},'宏库管理'),(0,x.createElementVNode)('div',{class:'macro-theme-sub'},'在这里选择需要显示在快捷回复的内容')],-1)),(0,x.createElementVNode)('button',{class:'macro-close',type:'button','aria-label':'关闭',title:'关闭',onClick:n[16]||(n[16]=e=>V.value=!1)},[...n[62]||(n[62]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-xmark','aria-hidden':'true'},null,-1)])])]),(0,x.createElementVNode)('div',me,[(0,x.createElementVNode)('div',pe,[n[65]||(n[65]=(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-magnifying-glass','aria-hidden':'true'},null,-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{'onUpdate:modelValue':n[17]||(n[17]=e=>N.value=e),class:'macro-search-input',placeholder:'搜索名称或内容'},null,512),[[x.vModelText,N.value]]),N.value?((0,x.openBlock)(),(0,x.createElementBlock)('button',{key:0,class:'macro-icon-btn is-ghost',type:'button','aria-label':'清除',onClick:n[18]||(n[18]=e=>N.value='')},[...n[64]||(n[64]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-xmark','aria-hidden':'true'},null,-1)])])):(0,x.createCommentVNode)('v-if',!0)]),(0,x.createElementVNode)('div',ue,[(0,x.createElementVNode)('button',{class:(0,x.normalizeClass)(['macro-filter-chip',{active:'all'===w.value}]),type:'button',onClick:n[19]||(n[19]=e=>w.value='all')},' 全部 ',2),(0,x.createElementVNode)('button',{class:(0,x.normalizeClass)(['macro-filter-chip',{active:'global'===w.value}]),type:'button',onClick:n[20]||(n[20]=e=>w.value='global')},' 全局 ',2),(0,x.createElementVNode)('button',{class:(0,x.normalizeClass)(['macro-filter-chip',{active:'character'===w.value}]),type:'button',onClick:n[21]||(n[21]=e=>w.value='character')},' 角色 ',2),(0,x.createElementVNode)('button',{class:(0,x.normalizeClass)(['macro-filter-chip',{active:C.value}]),type:'button',onClick:n[22]||(n[22]=e=>C.value=!C.value)},[...n[66]||(n[66]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-star','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 收藏 ',-1)])],2),(0,x.createElementVNode)('button',{class:(0,x.normalizeClass)(['macro-filter-chip',{active:B.value}]),type:'button',onClick:n[23]||(n[23]=e=>B.value=!B.value)},[...n[67]||(n[67]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-clock-rotate-left','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 最近 ',-1)])],2)]),(0,x.createElementVNode)('div',{class:(0,x.normalizeClass)(['macro-library-grid',{'is-editing':!!dn.value}])},[(0,x.createElementVNode)('div',fe,[(0,x.createElementVNode)('div',ve,[B.value?((0,x.openBlock)(),(0,x.createElementBlock)(x.Fragment,{key:0},[n[68]||(n[68]=(0,x.createElementVNode)('div',{class:'macro-subtitle'},'最近使用',-1)),(0,x.createElementVNode)('div',be,[((0,x.openBlock)(!0),(0,x.createElementBlock)(x.Fragment,null,(0,x.renderList)(an.value,e=>((0,x.openBlock)(),(0,x.createElementBlock)('div',{key:e.id,class:(0,x.normalizeClass)(['macro-item',{active:e.id===E.value}]),onClick:n=>yn(e.id),role:'button',tabindex:'0',onKeydown:[(0,x.withKeys)((0,x.withModifiers)(n=>yn(e.id),['prevent']),['enter']),(0,x.withKeys)((0,x.withModifiers)(n=>yn(e.id),['prevent']),['space'])]},[(0,x.createVNode)(S,{macro:e,mode:'library','character-label':mn(e),onPin:bn,onToggle:xn,onEdit:hn,onDelete:vn},null,8,['macro','character-label'])],42,xe))),128)),an.value.length?(0,x.createCommentVNode)('v-if',!0):((0,x.openBlock)(),(0,x.createElementBlock)('div',ge,'暂无最近使用'))])],64)):((0,x.openBlock)(),(0,x.createElementBlock)(x.Fragment,{key:1},[rn.value?((0,x.openBlock)(),(0,x.createElementBlock)(x.Fragment,{key:0},[n[69]||(n[69]=(0,x.createElementVNode)('div',{class:'macro-subtitle'},'最近使用',-1)),(0,x.createElementVNode)('div',he,[((0,x.openBlock)(!0),(0,x.createElementBlock)(x.Fragment,null,(0,x.renderList)(tn.value,e=>((0,x.openBlock)(),(0,x.createElementBlock)('div',{key:e.id,class:(0,x.normalizeClass)(['macro-item',{active:e.id===E.value}]),onClick:n=>yn(e.id),role:'button',tabindex:'0',onKeydown:[(0,x.withKeys)((0,x.withModifiers)(n=>yn(e.id),['prevent']),['enter']),(0,x.withKeys)((0,x.withModifiers)(n=>yn(e.id),['prevent']),['space'])]},[(0,x.createVNode)(S,{macro:e,mode:'library','character-label':mn(e),onPin:bn,onToggle:xn,onEdit:hn,onDelete:vn},null,8,['macro','character-label'])],42,ye))),128))])],64)):(0,x.createCommentVNode)('v-if',!0),cn.value.global.length?((0,x.openBlock)(),(0,x.createElementBlock)('div',ke,'全局')):(0,x.createCommentVNode)('v-if',!0),cn.value.global.length?((0,x.openBlock)(),(0,x.createElementBlock)('div',Ve,[((0,x.openBlock)(!0),(0,x.createElementBlock)(x.Fragment,null,(0,x.renderList)(cn.value.global,e=>((0,x.openBlock)(),(0,x.createElementBlock)('div',{key:e.id,class:(0,x.normalizeClass)(['macro-item',{active:e.id===E.value}]),onClick:n=>yn(e.id),role:'button',tabindex:'0',onKeydown:[(0,x.withKeys)((0,x.withModifiers)(n=>yn(e.id),['prevent']),['enter']),(0,x.withKeys)((0,x.withModifiers)(n=>yn(e.id),['prevent']),['space'])]},[(0,x.createVNode)(S,{macro:e,mode:'library','character-label':mn(e),onPin:bn,onToggle:xn,onEdit:hn,onDelete:vn},null,8,['macro','character-label'])],42,Ee))),128))])):(0,x.createCommentVNode)('v-if',!0),cn.value.character.length?((0,x.openBlock)(),(0,x.createElementBlock)('div',Ne,'角色')):(0,x.createCommentVNode)('v-if',!0),cn.value.character.length?((0,x.openBlock)(),(0,x.createElementBlock)('div',we,[((0,x.openBlock)(!0),(0,x.createElementBlock)(x.Fragment,null,(0,x.renderList)(cn.value.character,e=>((0,x.openBlock)(),(0,x.createElementBlock)('div',{key:e.id,class:(0,x.normalizeClass)(['macro-item',{active:e.id===E.value}]),onClick:n=>yn(e.id),role:'button',tabindex:'0',onKeydown:[(0,x.withKeys)((0,x.withModifiers)(n=>yn(e.id),['prevent']),['enter']),(0,x.withKeys)((0,x.withModifiers)(n=>yn(e.id),['prevent']),['space'])]},[(0,x.createVNode)(S,{macro:e,mode:'library','character-label':mn(e),onPin:bn,onToggle:xn,onEdit:hn,onDelete:vn},null,8,['macro','character-label'])],42,Ce))),128))])):(0,x.createCommentVNode)('v-if',!0),cn.value.global.length||cn.value.character.length?(0,x.createCommentVNode)('v-if',!0):((0,x.openBlock)(),(0,x.createElementBlock)('div',Be,' 没有匹配的快捷语句 '))],64))])]),dn.value?((0,x.openBlock)(),(0,x.createElementBlock)('div',ze,[(0,x.createElementVNode)('div',Me,[n[78]||(n[78]=(0,x.createElementVNode)('div',{class:'macro-section-title'},'编辑宏',-1)),(0,x.createElementVNode)('div',Te,[n[70]||(n[70]=(0,x.createElementVNode)('label',null,'名称',-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{class:'macro-input','onUpdate:modelValue':n[24]||(n[24]=e=>dn.value.name=e),placeholder:'例如：继续'},null,512),[[x.vModelText,dn.value.name]])]),(0,x.createElementVNode)('div',_e,[n[71]||(n[71]=(0,x.createElementVNode)('label',null,'内容',-1)),(0,x.withDirectives)((0,x.createElementVNode)('textarea',{ref_key:'libraryContentRef',ref:T,class:'macro-textarea','onUpdate:modelValue':n[25]||(n[25]=e=>dn.value.content=e),placeholder:'输入要插入的文本',onInput:un},null,544),[[x.vModelText,dn.value.content]])]),(0,x.createElementVNode)('div',De,[n[73]||(n[73]=(0,x.createElementVNode)('label',null,'作用范围',-1)),(0,x.createElementVNode)('div',Ie,[(0,x.withDirectives)((0,x.createElementVNode)('select',{'onUpdate:modelValue':n[26]||(n[26]=e=>dn.value.scope=e),class:'macro-select'},[...n[72]||(n[72]=[(0,x.createElementVNode)('option',{value:'global'},'全局快捷回复',-1),(0,x.createElementVNode)('option',{value:'character'},'角色快捷回复',-1)])],512),[[x.vModelSelect,dn.value.scope]]),'character'===dn.value.scope?((0,x.openBlock)(),(0,x.createElementBlock)('button',{key:0,class:'macro-btn is-ghost',type:'button',onClick:Nn},' 绑定当前角色 ')):(0,x.createCommentVNode)('v-if',!0),'character'===dn.value.scope?((0,x.openBlock)(),(0,x.createElementBlock)('span',Se,(0,x.toDisplayString)(mn(dn.value)),1)):(0,x.createCommentVNode)('v-if',!0)])]),(0,x.createElementVNode)('div',Ae,[n[77]||(n[77]=(0,x.createElementVNode)('label',{class:'macro-toggle'},'发送方式',-1)),(0,x.withDirectives)((0,x.createElementVNode)('select',{'onUpdate:modelValue':n[27]||(n[27]=e=>En.value=e),class:'macro-select'},[...n[74]||(n[74]=[(0,x.createElementVNode)('option',{value:'send'},'直接发送',-1),(0,x.createElementVNode)('option',{value:'append'},'追加到输入框',-1),(0,x.createElementVNode)('option',{value:'replace'},'覆盖输入框',-1)])],512),[[x.vModelSelect,En.value]]),(0,x.createElementVNode)('label',Ue,[(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':n[28]||(n[28]=e=>dn.value.newline=e)},null,512),[[x.vModelCheckbox,dn.value.newline]]),n[75]||(n[75]=(0,x.createTextVNode)(' 自动换行 ',-1))]),(0,x.createElementVNode)('label',Ke,[(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':n[29]||(n[29]=e=>dn.value.enabled=e)},null,512),[[x.vModelCheckbox,dn.value.enabled]]),n[76]||(n[76]=(0,x.createTextVNode)(' 显示在快捷回复 ',-1))])])])])):(0,x.createCommentVNode)('v-if',!0)],2)]),(0,x.createElementVNode)('footer',$e,[(0,x.createElementVNode)('button',{class:'macro-btn is-ghost',type:'button',onClick:kn},[...n[79]||(n[79]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-plus','aria-hidden':'true'},null,-1),(0,x.createTextVNode)(' 新增 ',-1)])]),(0,x.createElementVNode)('button',{class:'macro-btn is-primary',type:'button',onClick:n[30]||(n[30]=e=>V.value=!1)},'完成')])])])):(0,x.createCommentVNode)('v-if',!0),k.value?((0,x.openBlock)(),(0,x.createElementBlock)('div',{key:1,class:'macro-theme-modal',onClick:n[42]||(n[42]=(0,x.withModifiers)(e=>k.value=!1,['self']))},[(0,x.createElementVNode)('section',je,[(0,x.createElementVNode)('header',Le,[n[81]||(n[81]=(0,x.createElementVNode)('div',null,[(0,x.createElementVNode)('div',{class:'macro-theme-title'},'主题配色'),(0,x.createElementVNode)('div',{class:'macro-theme-sub'},'选择预设或手动微调颜色')],-1)),(0,x.createElementVNode)('button',{class:'macro-close',type:'button','aria-label':'关闭',title:'关闭',onClick:n[32]||(n[32]=e=>k.value=!1)},[...n[80]||(n[80]=[(0,x.createElementVNode)('i',{class:'macro-icon fa-solid fa-xmark','aria-hidden':'true'},null,-1)])])]),(0,x.createElementVNode)('div',Fe,[(0,x.createElementVNode)('div',Pe,[((0,x.openBlock)(!0),(0,x.createElementBlock)(x.Fragment,null,(0,x.renderList)((0,x.unref)(A),e=>((0,x.openBlock)(),(0,x.createElementBlock)('button',{key:e.name,class:'macro-theme-preset',type:'button',onClick:n=>{return a=e.colors,void(o.value={...a});var a}},[(0,x.createElementVNode)('span',{class:'macro-theme-dot',style:(0,x.normalizeStyle)({background:e.colors.accent})},null,4),(0,x.createTextVNode)(' '+(0,x.toDisplayString)(e.name),1)],8,He))),128))]),(0,x.createElementVNode)('div',qe,[(0,x.createElementVNode)('div',Re,[n[82]||(n[82]=(0,x.createElementVNode)('span',null,'背景',-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'color','onUpdate:modelValue':n[33]||(n[33]=e=>(0,x.unref)(o).bg=e)},null,512),[[x.vModelText,(0,x.unref)(o).bg]])]),(0,x.createElementVNode)('div',We,[n[83]||(n[83]=(0,x.createElementVNode)('span',null,'面板',-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'color','onUpdate:modelValue':n[34]||(n[34]=e=>(0,x.unref)(o).surface=e)},null,512),[[x.vModelText,(0,x.unref)(o).surface]])]),(0,x.createElementVNode)('div',Ye,[n[84]||(n[84]=(0,x.createElementVNode)('span',null,'面板辅助',-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'color','onUpdate:modelValue':n[35]||(n[35]=e=>(0,x.unref)(o).surfaceAlt=e)},null,512),[[x.vModelText,(0,x.unref)(o).surfaceAlt]])]),(0,x.createElementVNode)('div',Oe,[n[85]||(n[85]=(0,x.createElementVNode)('span',null,'文字',-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'color','onUpdate:modelValue':n[36]||(n[36]=e=>(0,x.unref)(o).text=e)},null,512),[[x.vModelText,(0,x.unref)(o).text]])]),(0,x.createElementVNode)('div',Ge,[n[86]||(n[86]=(0,x.createElementVNode)('span',null,'次级文字',-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'color','onUpdate:modelValue':n[37]||(n[37]=e=>(0,x.unref)(o).textMuted=e)},null,512),[[x.vModelText,(0,x.unref)(o).textMuted]])]),(0,x.createElementVNode)('div',Xe,[n[87]||(n[87]=(0,x.createElementVNode)('span',null,'强调色',-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'color','onUpdate:modelValue':n[38]||(n[38]=e=>(0,x.unref)(o).accent=e)},null,512),[[x.vModelText,(0,x.unref)(o).accent]])]),(0,x.createElementVNode)('div',Je,[n[88]||(n[88]=(0,x.createElementVNode)('span',null,'边框',-1)),(0,x.withDirectives)((0,x.createElementVNode)('input',{type:'color','onUpdate:modelValue':n[39]||(n[39]=e=>(0,x.unref)(o).border=e)},null,512),[[x.vModelText,(0,x.unref)(o).border]])])])]),(0,x.createElementVNode)('footer',Qe,[(0,x.createElementVNode)('button',{class:'macro-btn is-ghost',type:'button',onClick:n[40]||(n[40]=(...e)=>(0,x.unref)(h)&&(0,x.unref)(h)(...e))},'恢复默认主题'),(0,x.createElementVNode)('button',{class:'macro-btn is-primary',type:'button',onClick:n[41]||(n[41]=e=>k.value=!1)},'完成')])])])):(0,x.createCommentVNode)('v-if',!0)],2))}});function en(e,n){const a=(0,x.ref)(!1),r=(0,x.ref)([]),o=(0,x.ref)({...v}),c=(0,x.ref)(null),s=(0,x.computed)(()=>r.value.find(e=>e.id===c.value)??null);let p=null,u=null,f=null;const b=window.frameElement;function h(){b&&(b.style.position='fixed',b.style.inset='0',b.style.width='100vw',b.style.height='100vh',b.style.border='none',b.style.background='transparent',b.style.zIndex='9999')}function y(e){b&&(b.style.pointerEvents=e?'auto':'none',b.style.display=e?'block':'none')}function k(e){const n=document.querySelector('.macro-root');n&&(n.style.setProperty('--macro-bg',e.bg),n.style.setProperty('--macro-surface',e.surface),n.style.setProperty('--macro-surface-alt',e.surfaceAlt),n.style.setProperty('--macro-text',e.text),n.style.setProperty('--macro-text-muted',e.textMuted),n.style.setProperty('--macro-accent',e.accent),n.style.setProperty('--macro-border',e.border))}function V(){const n=e();r.value=_.cloneDeep(n.macros),o.value=_.cloneDeep(n.theme),r.value.length&&!c.value&&(c.value=r.value[0].id),c.value&&!r.value.some(e=>e.id===c.value)&&(c.value=r.value[0]?.id??null),k(o.value)}function E(e){'Escape'===e.key&&a.value&&(a.value=!1,y(!1))}function N(){if(u)return;if(!document.body||!document.head)return void setTimeout(N,50);h(),f=document.createElement('style'),f.setAttribute('data-macro-style',getScriptId()),f.textContent='\n    @import url(\'https://cdn.jsdelivr.net/gh/lxgw/LxgwWenkai-Webfont@1.7.0/style.css\');\n    @import url(\'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css\');\n\n    .macro-root {\n      position: fixed;\n      inset: 0;\n      width: 100vw;\n      height: 100vh;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      padding: 20px;\n      font-family: "LXGW WenKai", "PingFang SC", "Microsoft YaHei", sans-serif;\n      color: var(--macro-text, #f5f5f7);\n      background: transparent;\n      --macro-bg: #f6f1ea;\n      --macro-surface: #ffffff;\n      --macro-surface-alt: #f1ebe4;\n      --macro-text: #1c1c1c;\n      --macro-text-muted: #6a5f54;\n      --macro-accent: #d9934f;\n      --macro-border: #e3d6c9;\n      --macro-shadow: 0 22px 48px rgba(43, 34, 24, 0.22);\n      --macro-ring: rgba(217, 147, 79, 0.18);\n      z-index: 9999;\n    }\n\n    html, body {\n      margin: 0;\n      padding: 0;\n      width: 100%;\n      height: 100%;\n      overflow: hidden;\n      background: transparent;\n    }\n\n    .macro-root.open {\n      display: flex;\n    }\n\n    .macro-root.open .macro-panel {\n      animation: macro-panel-enter 0.22s ease;\n    }\n\n    .macro-root.open .macro-backdrop {\n      animation: macro-backdrop-fade 0.22s ease;\n    }\n\n    .macro-backdrop {\n      position: absolute;\n      inset: 0;\n      background: rgba(12, 14, 18, 0.52);\n      backdrop-filter: blur(8px) saturate(1.05);\n    }\n\n    .macro-panel {\n      position: relative;\n      width: min(920px, 100%);\n      max-width: 100%;\n      max-height: min(720px, 86vh);\n      height: auto;\n      background: var(--macro-surface) !important;\n      border: 1px solid var(--macro-border) !important;\n      border-radius: 22px;\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n      box-shadow: var(--macro-shadow);\n      z-index: 1;\n      color: var(--macro-text) !important;\n    }\n\n    .macro-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 16px 20px;\n      border-bottom: 1px solid var(--macro-border);\n      background: linear-gradient(135deg, rgba(217, 147, 79, 0.18), rgba(255, 250, 243, 0.9));\n    }\n\n    .macro-header-actions {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n    }\n\n    .macro-title__main {\n      font-size: 18px;\n      font-weight: 600;\n      letter-spacing: 0.6px;\n    }\n\n    .macro-title__sub {\n      font-size: 12px;\n      color: var(--macro-text-muted);\n      margin-top: 4px;\n    }\n\n    .macro-close {\n      border: 1px solid var(--macro-border);\n      background: var(--macro-surface);\n      color: var(--macro-text);\n      border-radius: 999px;\n      width: 34px;\n      height: 34px;\n      padding: 0;\n      cursor: pointer;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .macro-icon-btn {\n      border: 1px solid var(--macro-border);\n      background: var(--macro-surface);\n      color: var(--macro-text);\n      border-radius: 999px;\n      width: 32px;\n      height: 32px;\n      padding: 0;\n      cursor: pointer;\n      font-size: 12px;\n      line-height: 1;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .macro-icon {\n      font-size: 14px;\n      line-height: 1;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0.88;\n    }\n\n    .macro-icon.is-pinned {\n      color: var(--macro-accent);\n      opacity: 1;\n    }\n\n    .macro-icon-btn,\n    .macro-btn,\n    .macro-close,\n    .macro-select {\n      transition:\n        background-color 0.18s ease,\n        border-color 0.18s ease,\n        box-shadow 0.18s ease,\n        transform 0.18s ease;\n    }\n\n    .macro-icon-btn:hover,\n    .macro-close:hover {\n      background: color-mix(in srgb, var(--macro-surface) 78%, var(--macro-accent) 22%);\n      border-color: color-mix(in srgb, var(--macro-border) 40%, var(--macro-accent) 60%);\n    }\n\n    .macro-btn:hover {\n      background: color-mix(in srgb, var(--macro-surface) 78%, var(--macro-accent) 22%);\n      border-color: color-mix(in srgb, var(--macro-border) 40%, var(--macro-accent) 60%);\n    }\n\n    .macro-icon-btn:active,\n    .macro-btn:active,\n    .macro-close:active {\n      transform: translateY(1px) scale(0.98);\n    }\n\n    .macro-icon-btn.is-ghost {\n      border-color: transparent;\n      background: transparent;\n      width: 26px;\n      height: 26px;\n    }\n\n    .macro-icon-btn.is-ghost:hover {\n      background: color-mix(in srgb, var(--macro-surface) 70%, var(--macro-accent) 30%);\n    }\n\n    .macro-btn:disabled,\n    .macro-icon-btn:disabled,\n    .macro-close:disabled {\n      opacity: 0.45;\n      cursor: not-allowed;\n      transform: none;\n      box-shadow: none;\n    }\n\n    .macro-icon-btn:focus-visible,\n    .macro-btn:focus-visible,\n    .macro-close:focus-visible,\n    .macro-select:focus-visible {\n      outline: none;\n      border-color: var(--macro-accent);\n      box-shadow: 0 0 0 3px var(--macro-ring);\n    }\n\n    .macro-body {\n      flex: 1;\n      display: grid;\n      grid-template-columns: 280px minmax(0, 1fr);\n      min-height: 0;\n      min-width: 0;\n      overflow-x: hidden;\n    }\n\n    .macro-sidebar {\n      border-right: 1px solid var(--macro-border) !important;\n      background: color-mix(in srgb, var(--macro-surface) 70%, var(--macro-surface-alt) 30%) !important;\n      display: flex;\n      flex-direction: column;\n      min-height: 0;\n      min-width: 0;\n      color: var(--macro-text) !important;\n    }\n\n    .macro-section-title {\n      padding: 14px 16px;\n      font-size: 12px;\n      color: var(--macro-text-muted);\n      text-transform: uppercase;\n      letter-spacing: 1.2px;\n    }\n\n    .macro-list {\n      flex: 1;\n      overflow: auto;\n      overflow-x: hidden;\n      padding: 0 12px 12px;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n    }\n\n    .macro-group {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n    }\n\n    .macro-subtitle {\n      font-size: 11px;\n      text-transform: uppercase;\n      letter-spacing: 1.4px;\n      color: var(--macro-text-muted);\n      padding: 2px 6px 0;\n    }\n\n    .macro-empty-list {\n      font-size: 12px;\n      color: var(--macro-text-muted);\n      padding: 6px 6px 2px;\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n    }\n\n    .macro-empty-list .macro-btn {\n      align-self: flex-start;\n    }\n\n    .macro-item {\n      border: 1px solid transparent;\n      background: color-mix(in srgb, var(--macro-surface) 92%, transparent);\n      border-radius: 12px;\n      padding: 10px 12px;\n      margin-bottom: 0;\n      cursor: pointer;\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n      text-align: left;\n      color: inherit;\n      width: 100%;\n      box-sizing: border-box;\n    }\n\n    .macro-item:focus-visible {\n      outline: none;\n      border-color: var(--macro-accent);\n      box-shadow: 0 0 0 3px var(--macro-ring);\n    }\n\n    .macro-item__row {\n      display: grid;\n      grid-template-columns: minmax(0, 1fr) auto;\n      align-items: center;\n      gap: 10px;\n    }\n\n    .macro-item__actions {\n      display: flex;\n      gap: 6px;\n      flex-shrink: 0;\n    }\n\n    .macro-search {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      padding: 0 16px 10px;\n    }\n\n    .macro-search-input {\n      flex: 1;\n      border: 1px solid var(--macro-border);\n      background: var(--macro-surface);\n      color: var(--macro-text);\n      border-radius: 999px;\n      padding: 6px 12px;\n      font-size: 12px;\n    }\n\n    .macro-search-input:focus {\n      outline: none;\n      border-color: var(--macro-accent);\n      box-shadow: 0 0 0 3px var(--macro-ring);\n    }\n\n    .macro-filters {\n      display: flex;\n      flex-wrap: wrap;\n      gap: 6px;\n      padding: 0 16px 10px;\n    }\n\n    .macro-filter-chip {\n      border: 1px solid var(--macro-border);\n      background: var(--macro-surface);\n      color: var(--macro-text);\n      border-radius: 999px;\n      padding: 4px 10px;\n      font-size: 12px;\n      cursor: pointer;\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      transition: all 0.18s ease;\n    }\n\n    .macro-filter-chip.active {\n      background: color-mix(in srgb, var(--macro-accent) 20%, var(--macro-surface) 80%);\n      border-color: color-mix(in srgb, var(--macro-border) 40%, var(--macro-accent) 60%);\n      color: var(--macro-text);\n    }\n\n    .macro-filter-chip:hover {\n      background: color-mix(in srgb, var(--macro-surface) 78%, var(--macro-accent) 22%);\n      border-color: color-mix(in srgb, var(--macro-border) 40%, var(--macro-accent) 60%);\n    }\n\n    .macro-filter-chip .macro-icon {\n      font-size: 12px;\n    }\n\n    .macro-item__actions .macro-icon-btn {\n      width: 28px;\n      height: 28px;\n    }\n\n    .macro-item.active {\n      border-color: var(--macro-accent);\n      background: color-mix(in srgb, var(--macro-accent) 12%, var(--macro-surface) 88%);\n    }\n\n    .macro-item__name {\n      font-size: 14px;\n      font-weight: 600;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      white-space: nowrap;\n    }\n\n    .macro-item__meta {\n      font-size: 12px;\n      color: var(--macro-text-muted);\n      display: flex;\n      flex-wrap: wrap;\n      gap: 6px;\n    }\n\n    .macro-actions {\n      display: flex;\n      gap: 8px;\n      padding: 12px 16px 16px;\n      border-top: 1px solid var(--macro-border);\n    }\n\n    .macro-content {\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n      padding: 18px 20px;\n      overflow: auto;\n      overflow-x: hidden;\n      min-width: 0;\n      background: var(--macro-surface) !important;\n      color: var(--macro-text) !important;\n    }\n\n    .macro-field {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n    }\n\n    .macro-field label {\n      font-size: 13px;\n      color: var(--macro-text-muted);\n    }\n\n    .macro-input,\n    .macro-textarea {\n      width: 100%;\n      background: var(--macro-surface-alt) !important;\n      color: var(--macro-text) !important;\n      border: 1px solid var(--macro-border) !important;\n      border-radius: 12px;\n      padding: 10px 12px;\n      font-size: 14px;\n      box-shadow: none !important;\n    }\n\n    .macro-textarea {\n      min-height: 140px;\n      resize: vertical;\n    }\n\n    .macro-input:focus,\n    .macro-textarea:focus {\n      outline: none;\n      border-color: var(--macro-accent) !important;\n      box-shadow: 0 0 0 3px var(--macro-ring) !important;\n    }\n\n    .macro-root input,\n    .macro-root textarea {\n      background: var(--macro-surface-alt) !important;\n      color: var(--macro-text) !important;\n      border-color: var(--macro-border) !important;\n      box-shadow: none !important;\n      filter: none !important;\n    }\n\n    .macro-empty {\n      font-size: 13px;\n      color: var(--macro-text-muted);\n      padding: 8px 0;\n    }\n\n    .macro-toggle-row {\n      display: flex;\n      flex-wrap: wrap;\n      gap: 12px;\n      align-items: center;\n    }\n\n    .macro-toggle {\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      font-size: 13px;\n    }\n\n    .macro-tag {\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      padding: 2px 8px;\n      border-radius: 999px;\n      background: color-mix(in srgb, var(--macro-surface-alt) 70%, transparent);\n      border: 1px solid color-mix(in srgb, var(--macro-border) 80%, transparent);\n      font-size: 11px;\n      color: var(--macro-text-muted);\n    }\n\n    .macro-tag .macro-icon {\n      font-size: 12px;\n      opacity: 0.8;\n    }\n\n    .macro-theme-grid {\n      display: grid;\n      grid-template-columns: repeat(2, minmax(0, 1fr));\n      gap: 12px;\n    }\n\n    .macro-theme-modal {\n      position: absolute;\n      inset: 0;\n      background: rgba(12, 14, 18, 0.55);\n      backdrop-filter: blur(6px);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 24px;\n      z-index: 2;\n    }\n\n    .macro-library-modal {\n      position: absolute;\n      inset: 0;\n      background: rgba(12, 14, 18, 0.55);\n      backdrop-filter: blur(6px);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 24px;\n      z-index: 2;\n    }\n\n    .macro-library-panel {\n      width: min(920px, 100%);\n      max-height: min(760px, 90vh);\n      background: var(--macro-surface);\n      border: 1px solid var(--macro-border);\n      border-radius: 18px;\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n      box-shadow: var(--macro-shadow);\n    }\n\n    .macro-library-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 16px 20px 0;\n    }\n\n    .macro-library-body {\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n      padding: 8px 0 12px;\n      overflow: auto;\n      flex: 1;\n    }\n\n    .macro-library-grid {\n      display: grid;\n      grid-template-columns: 1fr;\n      gap: 16px;\n      padding: 0 20px 12px;\n      min-height: 0;\n    }\n\n    .macro-library-grid.is-editing {\n      grid-template-columns: minmax(0, 1fr) minmax(0, 360px);\n    }\n\n    .macro-library-list,\n    .macro-library-editor {\n      min-width: 0;\n      min-height: 0;\n    }\n\n    .macro-library-editor {\n      border-left: 1px solid var(--macro-border);\n      padding-left: 16px;\n      overflow: auto;\n      max-height: 100%;\n    }\n\n    .macro-library-list .macro-list {\n      padding: 0;\n    }\n\n    .macro-editor {\n      display: flex;\n      flex-direction: column;\n      gap: 16px;\n    }\n\n    .macro-library-footer {\n      display: flex;\n      justify-content: flex-end;\n      gap: 10px;\n      padding: 14px 20px;\n      border-top: 1px solid var(--macro-border);\n      background: var(--macro-surface-alt);\n    }\n\n    .macro-library-body .macro-search,\n    .macro-library-body .macro-filters {\n      padding: 0 20px 10px;\n    }\n\n    .macro-theme-panel {\n      width: min(720px, 92vw);\n      background: var(--macro-surface);\n      border: 1px solid var(--macro-border);\n      border-radius: 18px;\n      display: flex;\n      flex-direction: column;\n      gap: 16px;\n      box-shadow: var(--macro-shadow);\n    }\n\n    .macro-theme-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 16px 20px 0;\n    }\n\n    .macro-theme-title {\n      font-size: 18px;\n      font-weight: 600;\n    }\n\n    .macro-theme-sub {\n      font-size: 12px;\n      color: var(--macro-text-muted);\n      margin-top: 4px;\n    }\n\n    .macro-theme-body {\n      display: flex;\n      flex-direction: column;\n      gap: 16px;\n      padding: 0 20px;\n    }\n\n    .macro-theme-presets {\n      display: flex;\n      flex-wrap: wrap;\n      gap: 10px;\n    }\n\n    .macro-theme-preset {\n      border: 1px solid var(--macro-border);\n      background: rgba(12, 14, 20, 0.12);\n      color: var(--macro-text);\n      border-radius: 999px;\n      padding: 6px 14px;\n      font-size: 13px;\n      cursor: pointer;\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n    }\n\n    .macro-theme-dot {\n      width: 10px;\n      height: 10px;\n      border-radius: 50%;\n      display: inline-block;\n    }\n\n    .macro-theme-footer {\n      display: flex;\n      justify-content: flex-end;\n      gap: 10px;\n      padding: 0 20px 18px;\n    }\n\n    .macro-select {\n      appearance: none;\n      background: var(--macro-surface-alt) !important;\n      color: var(--macro-text) !important;\n      border: 1px solid var(--macro-border) !important;\n      border-radius: 12px;\n      padding: 8px 36px 8px 12px;\n      font-size: 13px;\n      background-image: url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'20\' height=\'20\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%236a5f54\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3E%3Cpath d=\'M6 9l6 6 6-6\'/%3E%3C/svg%3E");\n      background-repeat: no-repeat;\n      background-position: right 10px center;\n      background-size: 14px;\n    }\n\n    .macro-scope-row {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      flex-wrap: wrap;\n    }\n\n    .macro-scope-hint {\n      font-size: 12px;\n      color: var(--macro-text-muted);\n      max-width: 220px;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      white-space: nowrap;\n    }\n\n    .macro-theme-item {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 10px;\n      background: color-mix(in srgb, var(--macro-surface) 86%, var(--macro-text) 14%);\n      border: 1px solid var(--macro-border);\n      border-radius: 12px;\n      padding: 8px 10px;\n      font-size: 12px;\n      color: var(--macro-text-muted);\n    }\n\n    .macro-theme-item input[type="color"] {\n      border: none;\n      background: transparent;\n      width: 36px;\n      height: 24px;\n      padding: 0;\n    }\n\n    .macro-btn {\n      border: 1px solid var(--macro-border);\n      background: color-mix(in srgb, var(--macro-surface) 88%, var(--macro-text) 12%);\n      color: var(--macro-text);\n      border-radius: 12px;\n      padding: 8px 12px;\n      font-size: 13px;\n      cursor: pointer;\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n    }\n\n    .macro-btn.is-primary {\n      border-color: var(--macro-accent);\n      background: var(--macro-accent);\n      color: #05131b;\n      font-weight: 600;\n    }\n\n    .macro-btn.is-ghost {\n      background: transparent;\n    }\n\n    .macro-footer {\n      display: flex;\n      justify-content: flex-end;\n      gap: 10px;\n      padding: 14px 20px;\n      border-top: 1px solid var(--macro-border);\n      background: linear-gradient(180deg, color-mix(in srgb, var(--macro-surface) 90%, transparent), var(--macro-surface-alt));\n    }\n\n    .macro-list::-webkit-scrollbar,\n    .macro-content::-webkit-scrollbar {\n      width: 8px;\n      height: 8px;\n    }\n\n    .macro-list::-webkit-scrollbar-thumb,\n    .macro-content::-webkit-scrollbar-thumb {\n      background: color-mix(in srgb, var(--macro-text) 15%, transparent);\n      border-radius: 999px;\n    }\n\n    @media (max-width: 900px) {\n      .macro-root {\n        padding: 12px;\n      }\n\n      .macro-body {\n        grid-template-columns: 1fr;\n      }\n\n      .macro-sidebar {\n        border-right: none;\n        border-bottom: 1px solid var(--macro-border);\n      }\n\n      .macro-library-grid {\n        grid-template-columns: 1fr;\n      }\n\n      .macro-library-editor {\n        border-left: none;\n        border-top: 1px solid var(--macro-border);\n        padding-left: 0;\n        padding-top: 16px;\n      }\n    }\n\n    @media (max-width: 640px) {\n      .macro-panel,\n      .macro-library-panel {\n        width: 100%;\n        max-height: 92vh;\n        border-radius: 16px;\n      }\n    }\n\n    @keyframes macro-panel-enter {\n      from {\n        opacity: 0;\n        transform: translateY(10px) scale(0.98);\n      }\n      to {\n        opacity: 1;\n        transform: translateY(0) scale(1);\n      }\n    }\n\n    @keyframes macro-backdrop-fade {\n      from {\n        opacity: 0;\n      }\n      to {\n        opacity: 1;\n      }\n    }\n  ',document.head.appendChild(f),u=document.createElement('div'),u.className='macro-mount',u.setAttribute('script_id',getScriptId()),document.body.appendChild(u),p=(0,x.createApp)(Ze);const e=(0,x.computed)(()=>function(){const e=t(),n=Number(e),a=SillyTavern?.characters;return!Number.isNaN(n)&&a?.[n]?.name?`当前角色：${a[n].name}`:e?`当前角色ID：${e}`:'未选择角色'}()),b={visible:a,macros:r,theme:o,selectedId:c,selectedMacro:s,selectMacro:e=>{c.value=e},currentCharacterLabel:e,bindCurrentCharacter:()=>{const e=s.value;e&&(e.scope='character',e.characterId=t())},close:()=>{a.value=!1},addMacro:()=>{const e=d('新快捷语句',r.value),n={id:SillyTavern.uuidv4(),name:e,content:'',send:!1,append:!1,newline:!0,scope:'global',characterId:'',pinned:!1,lastUsedAt:0,enabled:!0};r.value.push(n),c.value=n.id},duplicateMacro:()=>{const e=s.value;if(!e)return;const n=d(`${e.name} 副本`,r.value),a={..._.cloneDeep(e),id:SillyTavern.uuidv4(),name:n};r.value.push(a),c.value=a.id},removeMacro:()=>{const e=s.value;if(!e)return;const n=r.value.filter(n=>n.id!==e.id);r.value=n,c.value=n[0]?.id??null},moveMacro:e=>{const n=s.value;if(!n)return;const a=r.value.findIndex(e=>e.id===n.id),t=a+e;if(t<0||t>=r.value.length)return;const o=[...r.value],[c]=o.splice(a,1);o.splice(t,0,c),r.value=o},resetTheme:()=>{o.value={...v}},save:()=>{const e=i(l(r.value,t()));e.warnings.forEach(e=>toastr.warning(e));const c={macros:e.macros,theme:m.parse(o.value)};n(c),a.value=!1}};p.provide(g,b),p.mount(u),k(m.parse(o.value)),y(a.value)}return h(),y(!1),(0,x.watch)(()=>o.value,e=>k(m.parse(e)),{deep:!0}),(0,x.watch)(()=>a.value,async e=>{e?(await(0,x.nextTick)(),y(!0)):y(!1)}),window.parent.addEventListener('keydown',E),{open:function(){N(),V(),a.value=!0,setTimeout(()=>{const e=document.querySelector('[data-focus="name"]');e?.focus()},0)},syncFromSettings:V,destroy:()=>{window.parent.removeEventListener('keydown',E),p?.unmount(),u?.remove(),f?.remove(),u=null,f=null,p=null,y(!1)}}}function nn(){let r=function(n){const a=getVariables(e);let t=u.parse(a??{});return Array.isArray(a?.macros)?t.macros=c(t.macros):(t={macros:c(f),theme:v},replaceVariables(t,e)),t.macros=l(t.macros,n()),a?.theme||(t.theme=v,replaceVariables(t,e)),t}(t);const d=i(r.macros);let s;d.warnings.length&&d.warnings.forEach(e=>toastr.warning(e)),r={macros:d.macros,theme:m.parse(r.theme)},b(r);const p=function(e){const t=[];let r=null;function o(){for(;t.length;)t.pop().stop()}return{render:function(t){const r=a(t,e.getCurrentCharacterId()),o=[{name:n,visible:!0},...r.map(e=>({name:e.name,visible:!0}))];replaceScriptButtons(o)},bind:function(n){o(),a(n,e.getCurrentCharacterId()).forEach(n=>{t.push(eventOn(getButtonEvent(n.name),()=>{e.applyMacro(n)}))})},ensureManageButton:function(e){r||(r=eventOn(getButtonEvent(n),()=>{e.open()}))},dispose:function(){o(),r?.stop(),r=null}}}({getCurrentCharacterId:t,applyMacro:async e=>{await o(e);const n=r.macros.find(n=>n.id===e.id);n&&(n.lastUsedAt=Date.now(),b(r),s?.syncFromSettings())}});p.render(r),p.bind(r),s=en(()=>r,e=>{r=e,b(r),p.render(r),p.bind(r)}),p.ensureManageButton(s);const x=eventOn(tavern_events.CHAT_CHANGED,()=>{p.render(r),p.bind(r)});$(window).on('pagehide',()=>{x.stop(),p.dispose(),s.destroy()})}$(()=>{errorCatched(nn)()});
//# sourceMappingURL=index.js.map