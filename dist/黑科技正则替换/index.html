<head><script type="module">import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';const t=Vue,n={class:'th-panel'},o={class:'th-header'},a={class:'th-tools'},c={key:0,class:'fa-solid fa-moon'},l={key:1,class:'fa-solid fa-sun'},s={class:'th-card'},r={class:'th-card__header'},i={key:0,class:'fa-regular fa-copy'},d={key:1,class:'fa-solid fa-check'},u=['innerHTML'],m={class:'th-badge'},h={class:'th-card__body'},v=['innerHTML'],p='th-ui-theme',f='th-ui-theme-channel',y='th-ui-theme-event',w=(0,t.defineComponent)({__name:'app',setup(e){const w=(0,t.ref)(''),g=(0,t.ref)(''),E=(0,t.ref)(0),k=(0,t.ref)(!0),b=(0,t.ref)(!0),V=(0,t.ref)(!0),C=(0,t.ref)(!1),N=(0,t.ref)(!1),L=String(window.__TH_RAW__??'');function S(){const e=document.body;V.value?(e.classList.remove('theme-light'),e.classList.add('theme-dark')):(e.classList.remove('theme-dark'),e.classList.add('theme-light')),A()}function B(){if(!b.value)return;const e=(new Date).getHours(),t=e>=6&&e<18;V.value=!t,S()}function H(){b.value=!0,B()}function T(){b.value=!1,V.value=!V.value,S()}function M(){setTimeout(()=>{const e=document.body.scrollHeight;window.parent&&window.parent!==window&&window.parent.postMessage({type:'resizeIframe',height:e},'*')},50)}async function x(){k.value=!k.value,k.value||N.value||(await async function(){const e=function(e){const t=e.split(/[,，\s]+/),n=[];for(let e=0;e<t.length;e++){const o=t[e].replace(/^\s+|\s+$/g,'');o&&((/^AM\d+$/i.test(o)||/^\d+$/.test(o))&&n.push(o))}return n}(function(e){const t=e.match(/<recall>([\s\S]*?)<\/recall>/);return t?t[1].replace(/^\s+|\s+$/g,''):''}(L));if(E.value=e.length,0===e.length)return void(g.value='<div class="th-muted">暂无回声</div>');let t='';try{if(g.value='<div class="th-muted">载入中…</div>','function'==typeof getVariables){const e=await getVariables({type:'chat'});e&&e.selectedWorldBook&&(t=e.selectedWorldBook)}if(t||'function'!=typeof getCurrentCharPrimaryLorebook||(t=await getCurrentCharPrimaryLorebook()),!t||'function'!=typeof getLorebookEntries)return g.value=e.map(e=>P(e,null)).join(''),void M();const n=await getLorebookEntries(t);if(!n)return;g.value=e.map(e=>P(e,function(e,t){const n=t.toUpperCase();for(let t=0;t<e.length;t++){const o=e[t];if(o.key&&o.key.length)for(let e=0;e<o.key.length;e++)if(String(o.key[e]).toUpperCase()===n)return o}return null}(n,e))).join(''),M()}catch(t){console.error('记忆召回失败:',t),g.value=e.map(e=>P(e,null)).join(''),M()}}(),N.value=!0),M()}function I(e){const t=document.createElement('div');return t.textContent=e,t.innerHTML}function P(e,t){if(!t)return`<div class="th-memory-item"><div class="th-memory-item__id">${I(e)}</div></div>`;const n=t.comment||'无标题',o=t.content||'（无内容）';return`<div class="th-memory-item"><div class="th-memory-item__id">${I(e)}</div><div class="th-memory-item__title">${I(n)}</div><div class="th-memory-item__body">${I(o)}</div></div>`}function j(e){e.stopPropagation();const t=w.value.replace(/<[^>]+>/g,'').trim(),n=document.createElement('textarea');n.value=t,document.body.appendChild(n),n.select();try{document.execCommand('copy'),C.value=!0,setTimeout(()=>C.value=!1,1200)}catch(e){console.error('Copy failed',e)}document.body.removeChild(n)}function A(){const e=JSON.stringify({mode:b.value?'auto':'manual',dark:V.value,updatedAt:Date.now()});try{localStorage.setItem(p,e)}catch(e){console.warn('[theme-sync] failed to write storage',e)}try{const t=new BroadcastChannel(f);t.postMessage(e),t.close()}catch(e){console.warn('[theme-sync] failed to broadcast',e)}try{window.parent&&window.parent!==window&&(window.parent.__TH_UI_THEME__=e,window.parent.dispatchEvent(new CustomEvent(y,{detail:e})))}catch(e){console.warn('[theme-sync] failed to notify parent',e)}}function U(e){if(e)try{const t=JSON.parse(e);if('auto'===t.mode)return b.value=!0,void B();'manual'===t.mode&&(b.value=!1,'boolean'==typeof t.dark&&(V.value=t.dark),S())}catch(e){console.warn('[theme-sync] failed to parse storage',e)}}return(0,t.onMounted)(()=>{!function(){try{if(window.parent&&window.parent!==window){const e=window.parent.document,t=e.querySelector('.mes_text')||e.querySelector('.message')||e.body,n=window.parent.getComputedStyle(t),o=n.fontSize,a=n.lineHeight;o&&(document.documentElement.style.setProperty('--st-font-size',o),document.body.style.fontSize=o),a&&(document.body.style.lineHeight=a)}}catch(e){console.warn('[font-sync] failed to read parent font size',e)}}();const e=localStorage.getItem(p);e?U(e):A(),window.addEventListener('storage',e=>{e.key===p&&U(e.newValue)});try{new BroadcastChannel(f).addEventListener('message',e=>U(String(e.data||'')))}catch(e){console.warn('[theme-sync] failed to listen broadcast',e)}try{if(window.parent&&window.parent!==window){window.parent.addEventListener(y,e=>{U(String(e.detail||''))});const e=window.parent.__TH_UI_THEME__;e&&U(e)}}catch(e){console.warn('[theme-sync] failed to listen parent event',e)}B(),function(){const e=function(e){const t=e.match(/<本轮用户输入>([\s\S]*?)<\/本轮用户输入>/);return t?t[1].replace(/^\s+|\s+$/g,''):''}(L).replace(/^\s+|\s+$/g,'');w.value=e?I(e):'<span class="th-muted">（无输入内容）</span>'}(),M()}),(e,p)=>((0,t.openBlock)(),(0,t.createElementBlock)('div',n,[(0,t.createElementVNode)('div',o,[p[0]||(p[0]=(0,t.createElementVNode)('div',{class:'th-title'},[(0,t.createElementVNode)('span',{class:'th-title__dot'}),(0,t.createTextVNode)(' 记忆索引 ')],-1)),(0,t.createElementVNode)('div',a,[(0,t.createElementVNode)('button',{class:(0,t.normalizeClass)(['th-btn',{active:b.value}]),onClick:H},'自动',2),(0,t.createElementVNode)('button',{class:'th-btn',onClick:T},[V.value?((0,t.openBlock)(),(0,t.createElementBlock)('i',c)):((0,t.openBlock)(),(0,t.createElementBlock)('i',l))])])]),(0,t.createElementVNode)('section',s,[(0,t.createElementVNode)('div',r,[p[1]||(p[1]=(0,t.createElementVNode)('div',{class:'th-card__title'},'输入',-1)),(0,t.createElementVNode)('button',{class:'th-icon-btn',onClick:j,title:'复制内容'},[C.value?((0,t.openBlock)(),(0,t.createElementBlock)('i',d)):((0,t.openBlock)(),(0,t.createElementBlock)('i',i))])]),(0,t.createElementVNode)('div',{class:'th-card__body',innerHTML:w.value},null,8,u)]),(0,t.createElementVNode)('section',{class:(0,t.normalizeClass)(['th-card th-card--collapsible',{collapsed:k.value}])},[(0,t.createElementVNode)('div',{class:'th-card__header',onClick:x},[p[2]||(p[2]=(0,t.createElementVNode)('div',{class:'th-card__title'},'回声',-1)),(0,t.createElementVNode)('span',m,(0,t.toDisplayString)(E.value),1),p[3]||(p[3]=(0,t.createElementVNode)('i',{class:'fa-solid fa-chevron-down th-chevron'},null,-1))]),(0,t.createElementVNode)('div',h,[(0,t.createElementVNode)('div',{class:'th-memory-list',innerHTML:g.value},null,8,v)])],2)]))}});$(()=>{const n=(0,t.createApp)(w).use(e());n.mount('#app'),$(window).on('pagehide',()=>n.unmount())});
//# sourceMappingURL=index.js.map</script><style>@import url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css);
/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */:root{--panel-bg-dark:rgba(30,26,38,0.82);--panel-bg-light:rgba(255,252,253,0.9);--panel-border-dark:rgba(255,192,203,0.14);--panel-border-light:rgba(219,112,147,0.18);--text-main-dark:#e9dfe6;--text-main-light:#5a3a4a;--text-sub-dark:#b097b3;--text-sub-light:#8a6a8a;--accent:#e8a9c2}body{font-family:"Noto Serif SC","Source Han Serif CN",serif;font-weight:600;font-size:var(--st-font-size,14px);background:rgba(0,0,0,0);color:var(--text-main-dark);margin:0;padding:10px}body.theme-dark{color:var(--text-main-dark)}body.theme-light{color:var(--text-main-light)}.th-panel{border-radius:18px;border:1px solid var(--panel-border-dark);background:var(--panel-bg-dark);padding:12px;display:grid;gap:12px;contain:content}body.theme-light .th-panel{background:var(--panel-bg-light);border-color:var(--panel-border-light)}.th-header{display:flex;align-items:center;justify-content:space-between;gap:10px}.th-title{font-weight:700;display:flex;align-items:center;gap:8px}.th-title__dot{width:8px;height:8px;border-radius:50%;background:var(--accent);display:inline-block}.th-tools{display:flex;align-items:center;gap:6px}.th-btn{border:1px solid var(--panel-border-dark);background:rgba(0,0,0,0);color:inherit;border-radius:999px;padding:4px 10px;font-size:.85em;cursor:pointer}body.theme-light .th-btn{border-color:var(--panel-border-light)}.th-btn.active{background:var(--accent);color:#fff;border-color:rgba(0,0,0,0)}.th-card{border:1px solid var(--panel-border-dark);border-radius:14px;padding:10px 12px;background:hsla(0,0%,100%,.04)}body.theme-light .th-card{border-color:var(--panel-border-light);background:rgba(0,0,0,.03)}.th-card__header{display:flex;align-items:center;gap:10px;cursor:default}.th-card--collapsible .th-card__header{cursor:pointer}.th-card__title{font-weight:700}.th-icon-btn{margin-left:auto;border:0;background:rgba(0,0,0,0);color:inherit;cursor:pointer}.th-badge{margin-left:auto;font-size:.8em;padding:2px 8px;border-radius:999px;background:rgba(232,169,194,.22)}.th-chevron{margin-left:6px;transition:transform .2s ease}.th-card--collapsible.collapsed .th-card__body{display:none}.th-card--collapsible.collapsed .th-chevron{transform:rotate(-90deg)}.th-card__body{margin-top:8px;line-height:1.6;word-break:break-word;white-space:pre-wrap}.th-muted{color:var(--text-sub-dark);font-style:italic}body.theme-light .th-muted{color:var(--text-sub-light)}.th-memory-list{display:grid;gap:8px}.th-memory-item{border:1px dashed var(--panel-border-dark);border-radius:12px;padding:8px 10px;background:rgba(0,0,0,.04)}body.theme-light .th-memory-item{border-color:var(--panel-border-light);background:rgba(0,0,0,.02)}.th-memory-item__id{font-size:.85em;font-weight:700;color:var(--accent);margin-bottom:4px}.th-memory-item__title{font-weight:700;margin-bottom:4px}.th-memory-item__body{font-size:.95em}@media (max-width:480px){body{padding:6px}}

/*# sourceMappingURL=main.css.map*/</style></head><body><div id="app"></div></body>