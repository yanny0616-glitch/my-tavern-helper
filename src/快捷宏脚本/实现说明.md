# 快捷宏脚本实现说明

## 目标

- 提供可编辑的“快捷宏脚本”管理弹窗。
- 支持快捷语句增删改、排序、发送/追加/换行选项。
- 主题颜色可自定义并持久化。
- 运行稳定，避免弹窗空白问题。

## 实现方式

- 参考 `src/角色卡管理插件/entry/portal.ts` 的挂载方式。
- 不使用 iframe 挂载弹窗，直接在酒馆主页面创建挂载点并注入样式。
- Vue 组件与业务逻辑拆分，保证可维护性。

## 代码结构

- `src/快捷宏脚本/index.ts`
  - 入口文件，仅在 `$(() => {})` 中调用初始化。
- `src/快捷宏脚本/entry/portal.ts`
  - 入口编排：
    - 初始化设置
    - 渲染按钮与绑定事件
    - 管理弹窗生命周期
- `src/快捷宏脚本/core/*`
  - `constants.ts`：脚本常量（按钮名、变量选项）。
  - `schema.ts`：zod schema、默认值与类型。
  - `settings.ts`：设置读写与默认值补齐。
  - `macros.ts`：宏的规范化与去重规则。
- `src/快捷宏脚本/integration/*`
  - `buttons.ts`：脚本按钮渲染与事件绑定。
  - `character.ts`：当前角色信息读取。
  - `input.ts`：输入框写入与宏应用入口。
  - `macro-strategies.ts`：宏行为策略（发送/追加/换行）。
- `src/快捷宏脚本/ui/App.vue`
  - 弹窗 UI：列表、编辑区、主题面板、底部操作区。
- `src/快捷宏脚本/ui/context.ts`
  - UI 上下文类型与 `provide/inject` Key。
- `src/快捷宏脚本/ui/manager.ts`
  - 管理弹窗创建、挂载、销毁与主题同步。
- `src/快捷宏脚本/ui/style.ts`
  - UI 样式字符串集中管理。

## 变量与数据

- 脚本变量：`{ type: 'script', script_id: getScriptId() }`
- 结构：
  - `macros`: `Macro[]`
  - `theme`: `Theme`
- 默认值：
  - `macros`: 问候/继续
  - `theme`: `ThemeSchema` 默认浅色调

## 关键交互

- 按钮名：`管理快捷语句`
- 点击按钮触发弹窗 `open()`。
- 弹窗内修改后点击“保存”写入脚本变量并刷新脚本按钮。

## 关键实现细节

- 使用 `createScriptIdIframe()` 在 iframe 中挂载 UI，实现样式完全隔离。
- 样式注入到 iframe 的 `<head>`，避免与酒馆页面样式相互污染。
- `watch(theme)` 实时更新 CSS 变量。
- 宏操作通过策略流水线处理（发送/追加/换行），便于扩展新行为。
- `pagehide` 时清理事件和 DOM。

## 遇到的问题与处理

1 弹窗空白

- 原因：使用 iframe 挂载，iframe 仍未完成初始化，导致 body 为空。
- 处理：改为在主页面挂载 + 注入样式，避免 iframe 异常。

2 主题不生效

- 原因：theme 变化未同步到 UI DOM。
- 处理：`watch(theme)` 并写入 CSS 变量。

3 可维护性不足

- 原因：全部逻辑堆在一个文件。
- 处理：拆分为 core/integration/ui 三层结构，入口仅负责编排。

## 继续修改建议

- 需要新增字段时，优先在 `MacroSchema` 与 `Macro` 类型里同步定义。
- UI 改动在 `src/快捷宏脚本/ui/App.vue` 完成，逻辑依职责拆到 core/integration/ui。
- 主题相关颜色请只改 CSS 变量和 theme 默认值，避免写死颜色；主题预设在 `src/快捷宏脚本/ui/theme-presets.ts`。
- 新增宏行为时，优先在 `src/快捷宏脚本/integration/macro-strategies.ts` 追加策略。
